{% extends 'main/base.html' %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet" />
<style>
  .fc-event { cursor: pointer; border-radius: 6px; }
  .pill { font-size: 11px; line-height: 1; padding: 2px 6px; border-radius: 9999px; border: 1px solid rgba(0,0,0,.08); }
  .pill-info { background: #e0f2fe; }
  .pill-warn { background: #fef9c3; }
  .pill-ok { background: #dcfce7; }
  .pill-stop { background: #fee2e2; }
  .pill-muted { background: #f1f5f9; }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; vertical-align: middle; }
  .legend-pending { background: #f59e0b; }
  .legend-active { background: #10b981; }
  .legend-done { background: #ef4444; }
  .modal { z-index: 1050; }
  .modal-box { max-width: 720px; }
  .timeline { position: relative; padding-left: 1rem; border-left: 3px solid #e5e7eb; }
  .timeline .item { margin-bottom: .75rem; }
  .timeline .item .dot { width: 10px; height: 10px; background:#0ea5e9; border-radius:50%; position:absolute; left:-6px; margin-top:4px; }
  .toolbar-chip { padding: 4px 10px; border-radius: 9999px; border: 1px solid #cbd5e1; font-size: 12px; cursor: pointer; }
  .toolbar-chip.active { background: #0ea5e9; color: white; border-color: #0ea5e9; }
  .toast { animation: slideInRight .3s ease-in-out; }
  .toast.hide { animation: slideOutRight .3s ease-in-out; }
  @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
  @keyframes slideOutRight { from { transform: translateX(0); } to { transform: translateX(100%); } }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <h1 class="text-2xl font-bold text-blue-600 uppercase flex items-center gap-2 mb-4">
    <i class="fas fa-user-clock text-blue-600"></i> Situation Administrative Actuelle
  </h1>

  <!-- Toolbar -->
  <div class="flex flex-wrap gap-3 items-end bg-white/70 p-3 rounded-lg border border-gray-200 mb-3">
    <div class="flex flex-col">
      <label class="text-xs text-gray-500 mb-1">Type</label>
      <select id="filterType" class="select select-bordered select-sm w-56 bg-gray-100 text-gray-800 border-gray-300">
        <option value="">Tous les types</option>
      </select>
    </div>

    <div class="flex flex-col">
      <label class="text-xs text-gray-500 mb-1">Statut</label>
      <div class="flex gap-2">
        <button class="toolbar-chip btn btn-sm bg-gray-100 text-gray-700 hover:bg-gray-200" data-status="">Tous</button>
        <button class="toolbar-chip btn btn-sm bg-gray-100 text-gray-700 hover:bg-gray-200" data-status="en attente">En attente</button>
        <button class="toolbar-chip btn btn-sm bg-gray-100 text-gray-700 hover:bg-gray-200" data-status="actif">Actif</button>
        <button class="toolbar-chip btn btn-sm bg-gray-100 text-gray-700 hover:bg-gray-200" data-status="terminé">Terminé</button>
        </div>
    </div>

    {% if request.user.role in 'MANAGER HR ADMIN' %}
    <div class="flex flex-col">
      <label class="text-xs text-gray-500 mb-1">Employé</label>
      <input id="filterEmployee" class="input input-bordered input-sm w-56  bg-gray-100 text-gray-800 border-gray-300" placeholder="Nom (contient)" />
    </div>
    {% endif %}

    <div class="flex-1"></div>

    {% if request.user.role in 'HR ADMIN' %}
    <button id="btnNewSituation" class="btn btn-primary btn-sm">+ Nouvelle Situation</button>
    {% endif %}
  </div>

  <!-- Legend -->
  <div class="flex flex-wrap items-center gap-4 text-sm text-base-content/70 mb-4">
    <span class="text-gray-500"><span class="badge badge-xs badge-warning mr-2">&nbsp;</span> En attente</span>
    <span class="text-gray-500"><span class="badge badge-xs badge-success mr-2">&nbsp;</span> Actif</span>
    <span class="text-gray-500"> <span class="badge badge-xs badge-error mr-2">&nbsp;</span>Terminé</span>
    <span class="badge badge-warning badge-sm">Suspend paie</span>
  </div>

  <!-- Calendar -->
  <div id="calendar" class="min-h-[28rem] bg-gray-100 shadow-xl rounded-lg border-l-4 border-blue-600 p-4"></div>

  <!-- Event Modal -->
  <input type="checkbox" id="eventModal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box bg-sky-50">
      <h3 class="font-bold text-lg">Détails de la Situation</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 py-4">
        <p><strong>Employé:</strong> <span id="eventEmployee"></span></p>
        <p><strong>Type:</strong> <span id="eventSituationType"></span></p>
        <p><strong>Code:</strong> <span id="eventTypeCode"></span></p>
        <p><strong>Suspend paie:</strong> <span id="eventSuspend"></span></p>
        <p><strong>Début:</strong> <span id="eventStart"></span></p>
        <p><strong>Fin:</strong> <span id="eventEnd"></span></p>
        <p><strong>Statut:</strong> <span id="eventStatus"></span></p>
        <p><strong>Document:</strong> <span id="eventDocument"></span></p>
        <p class="md:col-span-2"><strong>Disponibilité:</strong> <span id="eventAvailabilityReason"></span></p>
        <p class="md:col-span-2"><strong>Exclusion:</strong> <span id="eventExclusionReason"></span></p>
        <p class="md:col-span-2"><strong>Sortie:</strong> <span id="eventExitType"></span></p>
      </div>

      <!-- Tranche timeline -->
      <div class="mt-3">
        <h4 class="font-semibold mb-2">Tranches</h4>
        <div id="trancheWarnings" class="text-sm text-red-600 mb-2 hidden"></div>
        <div id="trancheTimeline" class="timeline"></div>
      </div>

      <div id="eventActions" class="mt-4 flex flex-wrap gap-2"></div>

      <div class="modal-action">
        <label for="eventModal" class="btn btn-secondary">Fermer</label>
      </div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <input type="checkbox" id="createEventModal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box bg-white">
      <h3 class="font-bold text-lg" id="createEventModalLabel">Nouvelle Situation Administrative</h3>
      <form id="situationCreateForm" enctype="multipart/form-data" class="grid grid-cols-1 gap-4">
        {% csrf_token %}
        <input type="hidden" name="employee_id" id="employeeIdInput" value="{{ request.user.employee.id|default:'' }}"/>

        <!-- Searchable employee combobox -->
        <div class="form-control">
        <label class="label"><span class="label-text">Employé</span></label>
        <div class="relative">
            <input
            id="employeeSearch"
            type="text"
            class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300"
            placeholder="Rechercher par nom… Sinon, {{ request.user.employee.first_name }} {{ request.user.employee.last_name }} sera selectionné."
            autocomplete="off"
            aria-expanded="false"
            aria-controls="employeeDropdown"
            role="combobox"
            />
            <div
            id="employeeDropdown"
            class="absolute z-30 mt-1 w-full bg-white rounded-box shadow max-h-60 overflow-auto border border-base-300 hidden"
            role="listbox"
            ></div>
        </div>
        <div id="employeeSelectedHint" class="mt-2 text-sm"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="label"><span class="label-text">Type</span></label>
            <select name="situation_type_id" id="situationType" class="select select-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300" required>
              <option value="" disabled selected>Sélectionner un type</option>
            </select>
          </div>
          <div>
            <label class="label"><span class="label-text">Statut</span></label>
            <select name="status" id="statusInput" class="select select-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
              <option value="en attente">En attente</option>
              <option value="actif">Actif</option>
              <option value="terminé">Terminé</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="label"><span class="label-text">Début</span></label>
            <input type="date" name="start_date" id="startDate" class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300" required>
          </div>
          <div>
            <label class="label"><span class="label-text">Fin</span></label>
            <input type="date" name="end_date" id="endDate" class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
          </div>
        </div>

        <!-- Tranches -->
        <details class="bg-gray-50 rounded-lg p-3">
          <summary class="cursor-pointer font-semibold">Tranches (optionnel)</summary>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
            <div>
              <label class="label"><span class="label-text">Tranche 1 (début)</span></label>
              <input type="date" name="tranche_1_start" id="t1s" class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
              <label class="label mt-2"><span class="label-text">Tranche 1 (fin)</span></label>
              <input type="date" name="tranche_1_end" id="t1e" class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
            </div>
            <div>
              <label class="label"><span class="label-text">Tranche 2 (début)</span></label>
              <input type="date" name="tranche_2_start" id="t2s" class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
              <label class="label mt-2"><span class="label-text">Tranche 2 (fin)</span></label>
              <input type="date" name="tranche_2_end" id="t2e" class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
            </div>
            <div>
              <label class="label"><span class="label-text">Tranche 3 (début)</span></label>
              <input type="date" name="tranche_3_start" id="t3s" class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
              <label class="label mt-2"><span class="label-text">Tranche 3 (fin)</span></label>
              <input type="date" name="tranche_3_end" id="t3e" class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
            </div>
          </div>
        </details>

        <!-- Misc -->
        <details class="bg-gray-50 rounded-lg p-3">
          <summary class="cursor-pointer font-semibold">Détails complémentaires</summary>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
            <div>
              <label class="label"><span class="label-text">Disponibilité (raison)</span></label>
              <textarea name="availability_reason" id="availabilityReason" class="textarea textarea-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300"></textarea>
            </div>
            <div>
              <label class="label"><span class="label-text">Exclusion (raison)</span></label>
              <textarea name="exclusion_reason" id="exclusionReason" class="textarea textarea-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="label"><span class="label-text">Type de sortie</span></label>
              <input type="text" name="exit_type" id="exitType" class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
            </div>
          </div>
        </details>

        <!-- Document -->
        <details class="bg-gray-50 rounded-lg p-3">
          <summary class="cursor-pointer font-semibold">Justificatif</summary>
          <div class="mt-3">
            <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50 hover:bg-gray-100 transition-colors" id="dropZone">
              <input type="file" name="document_file" id="documentInput"
                     class="file-input file-input-bordered w-full opacity-0 absolute inset-0 cursor-pointer"
                     accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
              <div class="text-center text-gray-600 pointer-events-none">
                <i class="fas fa-upload text-blue-500 text-2xl mb-2"></i>
                <p id="dropZoneText">Glissez & déposez un fichier ici ou cliquez…</p>
              </div>
            </div>
            <p id="fileName" class="text-sm text-gray-500 mt-2"></p>

            <!-- Extra document metadata (shown when a file is selected) -->
            <div id="documentDetails" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 hidden">
            <div>
                <label class="label"><span class="label-text">Type de Document</span></label>
                <select id="documentType" class="select select-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
                <option value="" disabled selected>Sélectionner un type</option>
                <option value="arrete">Arrêté</option>
                <option value="certificat_medical">Certificat Médical</option>
                <option value="contrat">Contrat</option>
                <option value="autre">Autre</option>
                </select>
            </div>
            <div>
                <label class="label"><span class="label-text">Date d'Émission</span></label>
                <input id="issuanceDate" type="date" class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300" />
            </div>
            <div>
                <label class="label"><span class="label-text">Émis par</span></label>
                <input id="issuedBy" type="text" class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300" />
            </div>
            <div class="md:col-span-2">
                <label class="label"><span class="label-text">Note (facultatif)</span></label>
                <textarea id="contentText" class="textarea textarea-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300"></textarea>
            </div>
            </div>

          </div>
        </details>

        <div class="modal-action">
          <label for="createEventModal" class="btn btn-secondary">Annuler</label>
          <button class="btn btn-primary" id="submitSituationRequest">Soumettre</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
    <input type="checkbox" id="confirmDeleteModal" class="modal-toggle" />
    <div class="modal">
    <div class="modal-box bg-white">
        <h3 class="font-bold text-lg">Confirmation</h3>
        <p class="py-4">Supprimer cette situation ?</p>
        <div class="modal-action">
        <label for="confirmDeleteModal" class="btn btn-ghost">Annuler</label>
        <button id="btnDeleteConfirm" class="btn btn-error">Supprimer</button>
        </div>
    </div>
    </div>

    <!-- Close Situation Modal -->
    <input type="checkbox" id="closeModal" class="modal-toggle" />
    <div class="modal">
    <div class="modal-box bg-white">
        <h3 class="font-bold text-lg">Clôturer la situation</h3>
        <label class="label"><span class="label-text">Date de fin (YYYY-MM-DD) — optionnel, Enter pour aujourd'hui :</span></label>
        <input id="closeEndDate" type="date" class="input input-bordered w-full bg-gray-100 text-gray-800 border-gray-300" />
        <div class="modal-action">
        <label for="closeModal" class="btn btn-ghost">Annuler</label>
        <button id="btnCloseConfirm" class="btn">Clôturer</button>
        </div>
    </div>
    </div>

    <!-- Replace Document Modal -->
    <input type="checkbox" id="replaceDocModal" class="modal-toggle" />
    <div class="modal">
    <div class="modal-box bg-white">
        <h3 class="font-bold text-lg">Remplacer le document</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
        <div class="md:col-span-2">
            <label class="label"><span class="label-text">Fichier</span></label>
            <input id="repFile" type="file" class="file-input file-input-bordered w-full bg-gray-100 text-gray-800 border-gray-300" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
        </div>
        <div>
            <label class="label"><span class="label-text">Type de Document</span></label>
            <select id="repType" class="select select-bordered w-full bg-gray-100 text-gray-800 border-gray-300" required>
            <option value="" disabled selected>Sélectionner un type</option>
            <option value="arrete">Arrêté</option>
            <option value="certificat_medical">Certificat Médical</option>
            <option value="contrat">Contrat</option>
            <option value="autre">Autre</option>
            </select>
        </div>
        <div>
            <label class="label"><span class="label-text">Date d'Émission</span></label>
            <input id="repIssuance" type="date" class="input input-bordered w-full bg-gray-100 text-gray-800 border-gray-300" required>
        </div>
        <div class="md:col-span-2">
            <label class="label"><span class="label-text">Émis par</span></label>
            <input id="repIssuedBy" type="text" class="input input-bordered w-full bg-gray-100 text-gray-800 border-gray-300" required>
        </div>
        <div class="md:col-span-2">
            <label class="label"><span class="label-text">Note (facultatif)</span></label>
            <textarea id="repNote" class="textarea textarea-bordered w-full bg-gray-100 text-gray-800 border-gray-300"></textarea>
        </div>
        </div>
        <div class="modal-action">
        <label for="replaceDocModal" class="btn btn-ghost">Annuler</label>
        <button id="btnReplaceDoc" class="btn btn-primary">Enregistrer</button>
        </div>
    </div>
    </div>


  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2 w-full max-w-xs pointer-events-none"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/locales-all.global.min.js"></script>
<script>
(function(){
  const ROLE = "{{ request.user.role|default:'' }}".trim().toUpperCase();
  const userId = "{{ request.user.id|default:'' }}";
  const employeeId = "{{ request.user.employee.id|default:'' }}";
  const currentEmployeeName =
    (`{{ request.user.employee.first_name|default:'' }} {{ request.user.employee.last_name|default:'' }}`.trim()) ||
    `{{ request.user.get_full_name|default:request.user.username }}`;

  function getCsrfToken(){ const c=document.cookie.split('; ').find(r=>r.startsWith('csrftoken=')); return c?c.split('=')[1]:''; }
  const fmt = d => moment(d).format('YYYY-MM-DD');

  // filters state
  const state = {
    status: "",
    typeId: "",
    employeeSearch: ""
  };

  // populate type filter & form select
  function loadTypes() {
    $.get('/api/v1/situation-types/', data => {
      const list = (data.results || data);
      // toolbar
      const fSel = $('#filterType').empty().append('<option value="">Tous les types</option>');
      list.forEach(x => fSel.append(`<option value="${x.id}">${x.name}</option>`));
      // form
      const sSel = $('#situationType').empty().append('<option value="" disabled selected>Sélectionner un type</option>');
      list.forEach(x => sSel.append(`<option value="${x.id}" data-code="${x.code}" data-suspend="${x.suspend_payroll}">${x.name}</option>`));
    });
  }

  // mapper → FullCalendar event
  function toEvent(item){
    const emp = item.employee || {};
    const st  = item.situation_type || {};
    const endExclusive = item.end_date ? moment(item.end_date).add(1,'day').format('YYYY-MM-DD') : null;
    return {
      id: item.id,
      title: `${(emp.first_name||'')} ${(emp.last_name||'')}`.trim() + (st.name ? ` — ${st.name}` : ''),
      start: item.start_date,
      end: endExclusive,
      allDay: true,
      extendedProps: {
        employee: emp,
        employee_id: item.employee_id || emp.id,
        employee_user_id: (emp.user && emp.user.id) || null,
        situation_type: st,
        status: item.status,
        document: item.document,
        availability_reason: item.availability_reason,
        exclusion_reason: item.exclusion_reason,
        exit_type: item.exit_type
      }
    };
  }

  // ownership + edit/delete rule (employee only)
  function isOwnerFromEvent(ev){
    const emp = ev?.extendedProps?.employee || {};
    return (
      String(emp?.user?.id ?? '') === String(userId) ||
      String(ev?.extendedProps?.employee_user_id ?? '') === String(userId) ||
      String(emp?.id ?? '') === String(employeeId) ||
      String(ev?.extendedProps?.employee_id ?? '') === String(employeeId)
    );
  }
  function canEmpEditOrDelete(ev){
    const status = String(ev?.extendedProps?.status||'').toLowerCase();
    const startsInFuture = moment(ev.start).startOf('day').isAfter(moment().startOf('day'));
    return ROLE === 'EMP' && isOwnerFromEvent(ev) && status === 'en attente' && startsInFuture;
  }

  // event content renderer: pills (status + suspend badge)
  /*
  function eventContent(arg){
    const st = arg.event.extendedProps.situation_type || {};
    const status = String(arg.event.extendedProps.status||'').toLowerCase();
    const container = document.createElement('div');
    const title = document.createElement('div');
    title.textContent = arg.event.title;
    title.style.fontSize = '12px';
    title.style.fontWeight = '600';
    const pills = document.createElement('div');
    pills.style.display = 'flex'; pills.style.flexWrap = 'wrap'; pills.style.gap = '4px'; pills.style.marginTop = '2px';
    const mk = (text, cls) => { const b=document.createElement('span'); b.className='pill '+cls; b.textContent=text; return b; };

    if (status === 'en attente') pills.appendChild(mk('EN ATTENTE','pill-warn'));
    else if (status === 'actif') pills.appendChild(mk('ACTIF','pill-ok'));
    else if (status === 'terminé') pills.appendChild(mk('TERMINÉ','pill-stop'));
    if (st && st.suspend_payroll) pills.appendChild(mk('SUSPEND PAIE','pill-warn'));
    if (st && st.code) pills.appendChild(mk(st.code.toUpperCase(),'pill-muted'));

    container.appendChild(title); container.appendChild(pills);
    return { domNodes: [container] };
  }
  */

  // daisyUI badges inside events (no custom colors)
  function eventContent(arg){
    const st=arg.event.extendedProps.situation_type||{};
    const status=String(arg.event.extendedProps.status||'').toLowerCase();

    const wrap=document.createElement('div');
    const title=document.createElement('div');
    title.textContent=arg.event.title;
    title.className='font-semibold text-xs';

    const pills=document.createElement('div');
    pills.className='flex flex-wrap gap-1 mt-0.5';

    const mk=(label,classes)=>{ const b=document.createElement('span'); b.className=`badge badge-sm ${classes}`; b.textContent=label; return b; };

    if (status==='en attente') pills.appendChild(mk('EN ATTENTE','badge-warning'));
    else if (status==='actif') pills.appendChild(mk('ACTIF','badge-success'));
    else if (status==='terminé') pills.appendChild(mk('TERMINÉ','badge-error'));
    if (st.suspend_payroll) pills.appendChild(mk('SUSPEND PAIE','badge-warning'));
    if (st.code) pills.appendChild(mk(st.code.toUpperCase(),'badge-ghost'));

    wrap.appendChild(title); wrap.appendChild(pills);
    return { domNodes:[wrap] };
  }


  // Document helpers (unchanged style)
  function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function pickDocUrl(obj){ if(!obj) return null; return obj.file?.url || obj.file_url || obj.url || (typeof obj.file==='string' ? obj.file : null); }
  function pickDocLabel(obj){ if(!obj) return null; return obj.original_name || obj.filename || obj.name || (typeof obj.file==='string' ? obj.file.split('/').pop() : null); }
  async function extractDocLink(detail){
    if(!detail) return null;
    let docObj = detail.document_detail || (typeof detail.document==='object' ? detail.document : null) || null;
    let docId  = (typeof detail.document==='number') ? detail.document : (docObj?.id || null);
    let href   = pickDocUrl(docObj) || detail.document_file || null;
    let label  = pickDocLabel(docObj);
    if (!href && docId){
      try{
        const doc = await $.getJSON(`/api/v1/documents/${docId}/`);
        href  = pickDocUrl(doc) || doc?.file || doc?.url || href;
        label = label || pickDocLabel(doc);
      }catch(_){}
    }
    if (href && !/^https?:\/\//.test(href) && !href.startsWith('/')) href = '/' + href;
    if (!label && href){ try{ label=decodeURIComponent(href.split('/').pop()); }catch{ label=href.split('/').pop(); } }
    return href ? { href, label } : null;
  }
  async function renderDocumentLink(eventId){
    const el = document.getElementById('eventDocument'); if(!el) return;
    el.textContent = 'Chargement...';
    try{
      const detail = await $.getJSON(`/api/v1/situations/situations/${eventId}/`);
      const link = await extractDocLink(detail);
      el.innerHTML = link ? `<a href="${link.href}" target="_blank" rel="noopener" class="underline text-blue-600">${escapeHtml(link.label || 'Voir le document')}</a>` : 'Aucun';
    }catch(_){ el.textContent = 'Aucun'; }
  }

    let modalCtx = { situationId: null };

    window.openConfirmDelete = function(id){
    modalCtx.situationId = id;
    document.getElementById('confirmDeleteModal').checked = true;
    };

    // wire confirm button once
    $('#btnDeleteConfirm').off('click').on('click', function(){
    const id = modalCtx.situationId;
    if (!id) return;
    $.ajax({
        url:`/api/v1/situations/situations/${id}/`,
        type:'DELETE',
        headers:{'X-CSRFToken': getCsrfToken()}
    })
    .done(()=>{
        showToast('Situation supprimée.', 'success');
        document.getElementById('confirmDeleteModal').checked = false;
        document.getElementById('eventModal').checked = false;
        calendar.refetchEvents();
    })
    .fail(xhr=> showToast(drfMessage(xhr,'Erreur lors de la suppression.'), 'error'));
    });

    window.openCloseModal = function(id){
    modalCtx.situationId = id;
    $('#closeEndDate').val('');      // clear previous value
    document.getElementById('closeModal').checked = true;
    };

    $('#btnCloseConfirm').off('click').on('click', function(){
    const id = modalCtx.situationId;
    if (!id) return;
    const end = $('#closeEndDate').val();
    const payload = {}; if (end) payload.end_date = end;
    $.post({
        url:`/api/v1/situations/situations/${id}/close/`,
        data: payload,
        headers:{'X-CSRFToken': getCsrfToken()}
    })
    .done(()=>{
        showToast('Situation clôturée.', 'success');
        document.getElementById('closeModal').checked = false;
        calendar.refetchEvents();
    })
    .fail(xhr=> showToast(drfMessage(xhr,'Erreur lors de la clôture.'),'error'));
    });

    window.openReplaceDoc = function(id){
    modalCtx.situationId = id;
    $('#repFile').val('');
    $('#repType').val('');
    $('#repIssuance').val('');
    $('#repIssuedBy').val('');
    $('#repNote').val('');
    document.getElementById('replaceDocModal').checked = true;
    };

    $('#btnReplaceDoc').off('click').on('click', async function(){
    const id = modalCtx.situationId;
    const file = $('#repFile')[0].files[0];
    const docType = $('#repType').val();
    const issuance = $('#repIssuance').val();
    const issuedBy = $('#repIssuedBy').val();
    const note = $('#repNote').val();

    if (!file) { showToast('Veuillez choisir un fichier.', 'error'); return; }
    if (!docType || !issuance || !issuedBy) {
        showToast('Type, Date d’émission et Émis par sont requis.', 'error'); return;
    }

    try{
        const ctId = await fetchSituationContentType();
        if (!ctId) { showToast("Impossible d'obtenir le ContentType pour Situation.", 'error'); return; }

        const fd = new FormData();
        fd.append('file', file);
        fd.append('document_type', docType);
        fd.append('issuance_date', issuance);
        fd.append('issued_by', issuedBy);
        if (note) fd.append('content_text', note);
        fd.append('status', 'to_validate');
        fd.append('content_type', ctId);
        fd.append('object_id', String(id));

        const docResp = await $.ajax({
        url: '/api/v1/documents/',
        type: 'POST',
        data: fd, processData:false, contentType:false,
        headers: { 'X-CSRFToken': getCsrfToken() }
        });

        await $.ajax({
        url: `/api/v1/situations/situations/${id}/`,
        type: 'PATCH',
        data: JSON.stringify({ document_id: docResp.id }),
        contentType: 'application/json',
        headers: { 'X-CSRFToken': getCsrfToken() }
        });

        showToast('Document remplacé.', 'success');
        document.getElementById('replaceDocModal').checked = false;
        renderDocumentLink(id);
    }catch(err){
        showToast(drfMessage(err,'Échec du remplacement.'),'error');
    }
    });


    // --- Searchable employee picker (remote) ---
    const EMPLOYEE_API = '/api/v1/employees/';

    function setSelectedEmployee(id, label) {
    $('#employeeIdInput').val(id || '');
    $('#employeeSearch').val(label || '');
    $('#employeeSelectedHint')
        .toggle(!!label)
        .text(label ? `Sélectionné : ${label}` : '');
    }

    function renderEmployeeResults(list) {
    const box = $('#employeeDropdown').empty();
    if (!list || !list.length) {
        box.append('<div class="px-4 py-2 text-sm" data-empty> Aucun autre résultat </div>');
        return;
    }
    list.forEach(emp => {
        const label = `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || (emp.full_name || `#${emp.id}`);
        const $btn = $(
        `<button type="button" class="btn btn-ghost justify-start w-full normal-case rounded-none hover:bg-base-200 employee-item"
                data-id="${emp.id}" data-text="${label}" role="option">${label}</button>`
        );
        $btn.on('click', () => {
        setSelectedEmployee(emp.id, label);
        $('#employeeDropdown').addClass('hidden');
        $('#employeeSearch').attr('aria-expanded', 'false');
        });
        box.append($btn);
    });
    }

    let empTimer = null;
    function fetchEmployees(q = '') {
    const url = `${EMPLOYEE_API}?page_size=20${q ? `&search=${encodeURIComponent(q)}` : ''}`;
    fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.json())
        .then(data => renderEmployeeResults(data.results || data))
        .catch(() => renderEmployeeResults([]));
    }

    /*
    function initEmployeePicker() {
    // default to current user
    setSelectedEmployee(employeeId, currentEmployeeName || 'Moi');
    // load first page
    fetchEmployees('');
    // open/close & live search
    const $input = $('#employeeSearch');
    const $dd = $('#employeeDropdown');
    $input.off('focus input keydown');
    $input.on('focus', () => { $dd.removeClass('hidden'); $input.attr('aria-expanded', 'true'); fetchEmployees($input.val()); });
    $input.on('input', () => {
        clearTimeout(empTimer);
        empTimer = setTimeout(() => fetchEmployees($input.val().trim()), 250);
    });
    $input.on('keydown', (e) => { if (e.key === 'Escape') { $dd.addClass('hidden'); $input.attr('aria-expanded','false'); } });
    $(document).on('click.sitEmp', (e) => {
        if (!$(e.target).closest('#employeeDropdown, #employeeSearch').length) {
        $dd.addClass('hidden'); $input.attr('aria-expanded','false');
        }
    });
    }
    */

    function initEmployeePicker({ openOnShow = true } = {}) {
    // default to current user (only if no value is already there)
    if (!$('#employeeIdInput').val()) {
        setSelectedEmployee(employeeId, currentEmployeeName || 'Moi');
    }

    // load first page
    fetchEmployees('');

    // wire once
    const $input = $('#employeeSearch');
    const $dd = $('#employeeDropdown');

    $input.off('focus input keydown');
    $input.on('focus', () => {
        $dd.removeClass('hidden');
        $input.attr('aria-expanded', 'true');
        fetchEmployees($input.val());
    });
    $input.on('input', () => {
        clearTimeout(empTimer);
        empTimer = setTimeout(() => fetchEmployees($input.val().trim()), 200);
    });
    $input.on('keydown', (e) => {
        if (e.key === 'Escape') {
        $dd.addClass('hidden');
        $input.attr('aria-expanded', 'false');
        }
    });

    // click outside
    $(document).off('click.sitEmp').on('click.sitEmp', (e) => {
        if (!$(e.target).closest('#employeeDropdown, #employeeSearch').length) {
        $dd.addClass('hidden');
        $input.attr('aria-expanded', 'false');
        }
    });

    // ensure it opens when the modal becomes visible (checkbox flip is async in daisyUI)
    if (openOnShow) {
        setTimeout(() => {
        $dd.removeClass('hidden');
        $input.attr('aria-expanded', 'true').trigger('focus');
        fetchEmployees($input.val());
        }, 60);
    }
    }


    async function fetchSituationContentType() {
    try {
        const resp = await fetch('/api/v1/contenttypes/', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'same-origin'
        });
        const data = await resp.json();
        const items = data.results || data;
        // Django ContentType lowercases model name
        const ct = items.find(ct => ct.model === 'situation' && ct.app_label === 'situation');
        return ct?.id || null;
    } catch {
        return null;
    }
    }



  // tranche timeline + warnings
  function renderTranches(data){
    const host = $('#trancheTimeline').empty();
    const warn = $('#trancheWarnings').addClass('hidden').empty();
    const start = data.start_date, end = data.end_date || null;
    let problems = [];
    for (let i=1;i<=3;i++){
      const s = data[`tranche_${i}_start`], e = data[`tranche_${i}_end`];
      if (!s && !e) continue;
      if ((s && !e) || (e && !s)) problems.push(`Tranche ${i}: dates incomplètes.`);
      if (s && e && s > e) problems.push(`Tranche ${i}: début après fin.`);
      if (s && start && s < start) problems.push(`Tranche ${i}: début < début de la situation.`);
      if (e && end && e > end) problems.push(`Tranche ${i}: fin > fin de la situation.`);
      const row = $(`<div class="item relative pl-3">
        <span class="dot"></span>
        <div class="text-sm"><strong>Tranche ${i}</strong> — ${s||'—'} → ${e||'—'}</div>
      </div>`);
      host.append(row);
    }
    if (problems.length){
      warn.removeClass('hidden').html(problems.map(x=>`• ${escapeHtml(x)}`).join('<br/>'));
    }
  }

  // Toast
  function showToast(message, type='error'){
    const toastContainer=document.getElementById('toastContainer');
    const toast=document.createElement('div');
    toastContainer.style.zIndex = '999';
    const types={ error:{bg:'bg-red-100',text:'text-red-800',border:'border-red-600',icon:'fa-exclamation-circle text-red-600'}, success:{bg:'bg-green-100',text:'text-green-800',border:'border-green-600',icon:'fa-check-circle text-green-600'} };
    const t=types[type]||types.error;
    toast.className=`toast ${t.bg} ${t.text} border-l-4 ${t.border} p-4 rounded-md shadow-lg flex items-start pointer-events-auto mb-2`;
    toast.innerHTML=`<i class="fas ${t.icon} mt-1 mr-3"></i><div class="flex-1"><p class="text-sm font-medium">${message}</p></div><button class="ml-2 text-gray-500 hover:text-gray-700" onclick="this.closest('.toast').remove()"><i class="fas fa-times"></i></button>`;
    toastContainer.appendChild(toast);
    setTimeout(()=>{ toast.classList.add('hide'); toast.addEventListener('animationend', ()=>toast.remove(), { once:true }); }, 5000);
  }
  function drfMessage(xhr, fallback='Une erreur est survenue'){
    try{
      const data = xhr?.responseJSON || (xhr?.responseText ? JSON.parse(xhr.responseText) : null);
      if (!data) return fallback;
      if (typeof data === 'string') return data;
      if (data.detail) return data.detail;
      const lines=[]; for (const [k,v] of Object.entries(data)){ if (v==null) continue; if (Array.isArray(v)) lines.push(`${k}: ${v.join(', ')}`); else if (typeof v==='object') lines.push(`${k}: ${JSON.stringify(v)}`); else lines.push(`${k}: ${v}`); }
      return lines.join('<br>') || fallback;
    }catch{ return fallback; }
  }

  // calendar
  const calendarEl = document.getElementById('calendar');
  let calendar;
  function fetchEvents(info, success, failure){
    const start = fmt(info.start), end = fmt(info.end);
    const params = new URLSearchParams();
    params.set('date_range', `${start} to ${end}`);
    params.set('active', 'true'); // current page ⇒ only active window
    if (state.status) params.set('status', state.status);
    if (state.typeId) params.set('situation_type_id', state.typeId);
    if (state.employeeSearch) params.set('search', state.employeeSearch);
    fetch(`/api/v1/situations/situations/?${params.toString()}`, { headers:{'X-Requested-With':'XMLHttpRequest'} })
      .then(r=>r.json())
      .then(data=>success((data.results||data||[]).map(toEvent)))
      .catch(err=>{ console.error(err); failure(err); showToast("Erreur lors du chargement des situations.", 'error'); });
  }

  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'fr',
    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
    selectable: ROLE === 'HR' || ROLE === 'ADMIN',               // employees create through HR/Admin only (per your flow)
    editable: ROLE === 'EMP',                                    // allow drag for employees but we'll guard per-event
    height: 'auto',
    expandRows: true,
    events: fetchEvents,
    eventContent: eventContent,
    eventAllow: function(dropInfo, draggedEvent){
      return canEmpEditOrDelete(draggedEvent) &&
             moment(dropInfo.start).startOf('day').isAfter(moment().startOf('day'));
    },
    eventDrop: function(info){
      if (!canEmpEditOrDelete(info.event)){ info.revert(); return; }
      const payload = {
        start_date: moment(info.event.start).format('YYYY-MM-DD'),
        end_date: info.event.end ? moment(info.event.end).subtract(1, 'days').format('YYYY-MM-DD') : null
      };
      $.ajax({
        url: `/api/v1/situations/situations/${info.event.id}/`,
        type: 'PATCH',
        data: JSON.stringify(payload),
        contentType: 'application/json',
        headers: { 'X-CSRFToken': getCsrfToken() }
      }).done(()=>{
        showToast('Dates mises à jour.', 'success'); calendar.refetchEvents();
      }).fail(xhr=>{
        showToast(drfMessage(xhr, 'Erreur lors de la mise à jour.'), 'error'); info.revert();
      });
    },
    eventClick: function(info){
      const emp = info.event.extendedProps.employee || {};
      const st  = info.event.extendedProps.situation_type || {};
      $('#eventEmployee').text(`${emp.first_name||''} ${emp.last_name||''}`.trim()||'N/A');
      $('#eventSituationType').text(st.name || 'N/A');
      $('#eventTypeCode').text(st.code || '—');
      $('#eventSuspend').text(st.suspend_payroll ? 'Oui' : 'Non');
      $('#eventStart').text(moment(info.event.start).format('YYYY-MM-DD'));
      $('#eventEnd').text(info.event.end ? moment(info.event.end).subtract(1,'days').format('YYYY-MM-DD') : '—');
      $('#eventStatus').text((info.event.extendedProps.status || '').toUpperCase());
      $('#eventAvailabilityReason').text(info.event.extendedProps.availability_reason || '—');
      $('#eventExclusionReason').text(info.event.extendedProps.exclusion_reason || '—');
      $('#eventExitType').text(info.event.extendedProps.exit_type || '—');
      renderDocumentLink(info.event.id);

      // fetch the full data to render tranches
      $.get(`/api/v1/situations/situations/${info.event.id}/`, data => renderTranches(data));

      // actions (role-aware)
      const actions = [];
      const status = String(info.event.extendedProps.status||'').toLowerCase();
      const isOwner = isOwnerFromEvent(info.event);
      const startsFuture = moment(info.event.start).startOf('day').isAfter(moment().startOf('day'));
      const isHrAdmin = (ROLE === 'HR' || ROLE === 'ADMIN');

      if ((isHrAdmin) || (ROLE==='EMP' && isOwner && status==='en attente' && startsFuture)) {
        actions.push(`<button class="btn btn-warning btn-sm" onclick="editSituation(${info.event.id})">Modifier</button>`);
        actions.push(`<button class="btn btn-error btn-sm" onclick="openConfirmDelete(${info.event.id})">Supprimer</button>`);
      }
      if (isHrAdmin) {
        if (status !== 'terminé') actions.push(`<button class="btn btn-sm" onclick="openCloseModal(${info.event.id})">Clôturer</button>`);
        if (status === 'terminé') actions.push(`<button class="btn btn-sm" onclick="reopenSituation(${info.event.id})">Rouvrir</button>`);
        //actions.push(`<label class="btn btn-sm">
            // <input type="file" id="replaceDocInput" class="hidden" />
            // Remplacer document
          //</label>`);
        actions.push(`<button class="btn btn-sm" onclick="openReplaceDoc(${info.event.id})">Remplacer document</button>`);
      }
      $('#eventActions').html(actions.join(' '));
      // wire replace
      /*
      if (isHrAdmin){
        const input = document.getElementById('replaceDocInput');
        if (input){
          input.onchange = async (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            try{
              const fd = new FormData();
              fd.append('file', file);
              fd.append('document_type', 'autre');
              fd.append('status', 'to_validate');
              const docResp = await $.ajax({
                url: '/api/v1/documents/', type:'POST', data: fd, processData:false, contentType:false,
                headers: { 'X-CSRFToken': getCsrfToken() }
              });
              await $.post({
                url: `/api/v1/situations/situations/${info.event.id}/attach_document/`,
                data: { document_id: docResp.id },
                headers: { 'X-CSRFToken': getCsrfToken() }
              });
              showToast('Document remplacé.', 'success');
              renderDocumentLink(info.event.id);
            }catch(err){ showToast(drfMessage(err,'Échec du remplacement.'),'error'); }
          }
        }
      }
      */

    if (isHrAdmin){
    const input = document.getElementById('replaceDocInput');
    if (input){
        input.onchange = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        try{
            const ctId = await fetchSituationContentType();
            if (!ctId) { showToast("Impossible d'obtenir le ContentType pour Situation.", 'error'); return; }

            const fd = new FormData();
            fd.append('file', file);
            fd.append('document_type', 'autre');
            fd.append('status', 'to_validate');
            fd.append('content_type', ctId);
            fd.append('object_id', String(info.event.id)); // bind to this situation

            const docResp = await $.ajax({
            url: '/api/v1/documents/',
            type: 'POST',
            data: fd, processData:false, contentType:false,
            headers: { 'X-CSRFToken': getCsrfToken() }
            });

            // link the situation to this new document
            await $.ajax({
            url: `/api/v1/situations/situations/${info.event.id}/`,
            type: 'PATCH',
            data: JSON.stringify({ document_id: docResp.id }),
            contentType: 'application/json',
            headers: { 'X-CSRFToken': getCsrfToken() }
            });

            showToast('Document remplacé.', 'success');
            renderDocumentLink(info.event.id);
        }catch(err){ showToast(drfMessage(err,'Échec du remplacement.'),'error'); }
        };
    }
    }


      initEmployeePicker();
      document.getElementById('eventModal').checked = true;
    },
    select: function(info){
      if (!(ROLE==='HR' || ROLE==='ADMIN')) return; // creation by HR/Admin per your rule
      $('#situationCreateForm')[0].reset();
      $('#startDate').val(fmt(info.start));
      $('#endDate').val(info.end ? moment(info.end).subtract(1,'days').format('YYYY-MM-DD') : '');
      $('#createEventModalLabel').text('Nouvelle Situation Administrative');
      $('#submitSituationRequest').removeData('id').text('Soumettre');
      initEmployeePicker({ openOnShow: true });
      document.getElementById('createEventModal').checked = true;
    }
  });
  calendar.render();

  // toolbar wiring
  loadTypes();
  $('#filterType').on('change', function(){ state.typeId = this.value; calendar.refetchEvents(); });
  $('.toolbar-chip').on('click', function(){
    $('.toolbar-chip').removeClass('active'); $(this).addClass('active');
    state.status = this.dataset.status || ''; calendar.refetchEvents();
  });
  $('#filterEmployee').on('input', function(){
    state.employeeSearch = this.value.trim(); // searched server-side by name/type
    // debounce:
    clearTimeout(window._empTimer);
    window._empTimer = setTimeout(()=> calendar.refetchEvents(), 300);
  });
  $('#btnNewSituation').on('click', function(){
    $('#situationCreateForm')[0].reset();
    $('#createEventModalLabel').text('Nouvelle Situation Administrative');
    $('#submitSituationRequest').removeData('id').text('Soumettre');
    initEmployeePicker();
    initEmployeePicker({ openOnShow: true });
    document.getElementById('createEventModal').checked = true;
  });

  // Document UI for create modal
  const dropZone = document.getElementById('dropZone');
  const documentInput = document.getElementById('documentInput');
  const dropZoneText = document.getElementById('dropZoneText');
  const fileNameDisplay = document.getElementById('fileName');
  /*
  function updateDocumentUI(){ const f=documentInput.files?.[0]; fileNameDisplay.textContent = f ? `Fichier sélectionné : ${f.name}` : ''; }
  if (dropZone){
    dropZone.addEventListener('dragover', e=>{ e.preventDefault(); dropZone.classList.add('border-blue-500','bg-blue-50'); dropZoneText.textContent='Relâchez pour déposer'; });
    dropZone.addEventListener('dragleave', e=>{ e.preventDefault(); dropZone.classList.remove('border-blue-500','bg-blue-50'); dropZoneText.textContent='Glissez & déposez un fichier…'; });
    dropZone.addEventListener('drop', e=>{ e.preventDefault(); dropZone.classList.remove('border-blue-500','bg-blue-50'); dropZoneText.textContent='Glissez & déposez un fichier…'; if (e.dataTransfer?.files?.length){ documentInput.files = e.dataTransfer.files; updateDocumentUI(); } });
  }
  documentInput.addEventListener('change', updateDocumentUI);
  */
    const documentDetails = document.getElementById('documentDetails');

    function updateDocumentUI(){
        const f = documentInput.files && documentInput.csvfiles[0];
        fileNameDisplay.textContent = f ? `Fichier sélectionné : ${f.name}` : '';
        documentDetails.classList.toggle('hidden', !f);
    }

    if (dropZone) {
        dropZone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropZone.classList.add('border-primary','bg-base-200'); dropZoneText.textContent='Relâchez pour déposer'; });
        dropZone.addEventListener('dragleave', (e)=>{ e.preventDefault(); dropZone.classList.remove('border-primary','bg-base-200'); dropZoneText.textContent='Glissez & déposez un fichier…'; });
        dropZone.addEventListener('drop', (e)=>{ e.preventDefault(); dropZone.classList.remove('border-primary','bg-base-200'); dropZoneText.textContent='Glissez & déposez un fichier…'; if (e.dataTransfer?.files?.length){ documentInput.files = e.dataTransfer.files; updateDocumentUI(); } });
    }
    documentInput.addEventListener('change', updateDocumentUI);


  // submit (create/update)
  /*
  $('#submitSituationRequest').on('click', async function(e){
    e.preventDefault();
    const id   = $(this).data('id');
    const url  = id ? `/api/v1/situations/situations/${id}/` : '/api/v1/situations/situations/';
    const method = id ? 'PATCH' : 'POST';
    const form   = $('#situationCreateForm')[0];
    const fd     = new FormData(form);

    const stVal = $('#situationType').val();
    if (!stVal){ showToast('Veuillez sélectionner un type.', 'error'); return; }
    fd.set('situation_type_id', stVal);
    fd.set('employee_id', $('#employeeIdInput').val() || "{{ request.user.employee.id|default:'' }}");

    try{
      const file = documentInput.files[0];
      if (file){
        const docFD = new FormData();
        docFD.append('file', file);
        docFD.append('document_type', 'autre');
        docFD.append('status', 'to_validate');
        const docResp = await $.ajax({
          url: '/api/v1/documents/', type:'POST', data: docFD, processData:false, contentType:false,
          headers: { 'X-CSRFToken': getCsrfToken() }
        });
        if (docResp?.id) fd.set('document_id', docResp.id);
      }

      await $.ajax({ url, type: method, data: fd, processData:false, contentType:false, headers:{'X-CSRFToken': getCsrfToken()} });
      showToast('Situation enregistrée avec succès.', 'success');
      $('#createEventModal').prop('checked', false);
      calendar.refetchEvents();
    }catch(xhr){
      showToast(drfMessage(xhr,'Vérifiez les champs requis'), 'error');
    }
  });
  */
    $('#submitSituationRequest').on('click', async function (e) {
    e.preventDefault();

    const id = $(this).data('id');                // if present ⇒ update
    const isUpdate = !!id;

    // Collect situation fields (without the file)
    const payload = {
        employee_id: $('#employeeIdInput').val() || "{{ request.user.employee.id|default:'' }}",
        situation_type_id: $('#situationType').val(),
        status: $('#statusInput').val(),
        start_date: $('#startDate').val(),
        end_date: $('#endDate').val() || null,
        tranche_1_start: $('#t1s').val() || null,
        tranche_1_end:   $('#t1e').val() || null,
        tranche_2_start: $('#t2s').val() || null,
        tranche_2_end:   $('#t2e').val() || null,
        tranche_3_start: $('#t3s').val() || null,
        tranche_3_end:   $('#t3e').val() || null,
        availability_reason: $('#availabilityReason').val() || '',
        exclusion_reason: $('#exclusionReason').val() || '',
        exit_type: $('#exitType').val() || ''
    };

    if (!payload.situation_type_id) { showToast('Veuillez sélectionner un type.', 'error'); return; }
    if (!payload.start_date) { showToast('La date de début est requise.', 'error'); return; }
    if (payload.end_date && payload.start_date > payload.end_date) {
        showToast('La date de fin doit être postérieure à la date de début.', 'error');
        return;
    }

    const file = documentInput.files && documentInput.files[0];
    const docMeta = {
        document_type: $('#documentType').val(),
        issuance_date: $('#issuanceDate').val(),
        issued_by: $('#issuedBy').val(),
        content_text: $('#contentText').val()
    };

    // 1) Create or update Situation (no document yet)
    try {
        let situationId = id;
        if (!isUpdate) {
        const created = await $.ajax({
            url: '/api/v1/situations/situations/',
            type: 'POST',
            data: payload,
            headers: { 'X-CSRFToken': getCsrfToken() }
        });
        situationId = created.id;
        } else {
        await $.ajax({
            url: `/api/v1/situations/situations/${id}/`,
            type: 'PATCH',
            data: payload,
            headers: { 'X-CSRFToken': getCsrfToken() }
        });
        }

        // 2) If a file is selected, upload it with correct content_type/object_id, then PATCH the situation
        if (file) {
        // basic validation for metadata if you want them required
        if (!docMeta.document_type || !docMeta.issuance_date || !docMeta.issued_by) {
            showToast('Veuillez renseigner Type/Date/Émis par pour le document.', 'error');
            return;
        }

        const ctId = await fetchSituationContentType();
        if (!ctId) { showToast("Impossible d'obtenir le ContentType pour Situation.", 'error'); return; }

        const docFD = new FormData();
        docFD.append('file', file);
        docFD.append('document_type', docMeta.document_type);
        docFD.append('issuance_date', docMeta.issuance_date);
        docFD.append('issued_by', docMeta.issued_by);
        if (docMeta.content_text) docFD.append('content_text', docMeta.content_text);
        docFD.append('status', 'to_validate');
        docFD.append('content_type', ctId);
        docFD.append('object_id', String(situationId));

        const docResp = await $.ajax({
            url: '/api/v1/documents/',
            type: 'POST',
            data: docFD, processData:false, contentType:false,
            headers: { 'X-CSRFToken': getCsrfToken() }
        });

        await $.ajax({
            url: `/api/v1/situations/situations/${situationId}/`,
            type: 'PATCH',
            data: JSON.stringify({ document_id: docResp.id }),
            contentType: 'application/json',
            headers: { 'X-CSRFToken': getCsrfToken() }
        });
        }

        showToast(isUpdate ? 'Situation mise à jour.' : 'Situation créée.', 'success');
        $('#createEventModal').prop('checked', false);
        calendar.refetchEvents();
    } catch (xhr) {
        showToast(drfMessage(xhr,'Vérifiez les champs requis'), 'error');
    }
    });

  // global actions for modal
  window.editSituation = function(id){
    $.get(`/api/v1/situations/situations/${id}/`, data => {
      $('#situationType').val(data.situation_type?.id).trigger('change');
      $('#statusInput').val(data.status);
      $('#startDate').val(data.start_date);
      $('#endDate').val(data.end_date || '');
      $('#availabilityReason').val(data.availability_reason || '');
      $('#exclusionReason').val(data.exclusion_reason || '');
      $('#exitType').val(data.exit_type || '');
      $('#createEventModalLabel').text('Modifier la Situation Administrative');
      $('#submitSituationRequest').data('id', id).text('Mettre à jour');
      
      // (re)wire picker & force selected employee to the one from the situation
        initEmployeePicker({ openOnShow: false });
        const emp = data.employee || data.employee_detail;
        const empLabel = `${emp.first_name||''} ${emp.last_name||''}`.trim() || `#${emp.id}`;
        setSelectedEmployee(emp.id, empLabel);

      document.getElementById('createEventModal').checked = true;
    }).fail(xhr => showToast(drfMessage(xhr,'Erreur lors du chargement.'),'error'));
  };

  window.deleteSituation = function(id){
    if (!confirm('Supprimer cette situation ?')) return;
    $.ajax({ url:`/api/v1/situations/situations/${id}/`, type:'DELETE', headers:{'X-CSRFToken': getCsrfToken()} })
      .done(()=>{ calendar.refetchEvents(); document.getElementById('eventModal').checked=false; showToast('Situation supprimée.', 'success'); })
      .fail(xhr=> showToast(drfMessage(xhr,'Erreur lors de la suppression.'), 'error'));
  };

  window.closeSituation = function(id){
    const end = prompt("Date de fin (YYYY-MM-DD) — optionnel, Enter pour aujourd'hui :","");
    const payload = {}; if (end) payload.end_date = end;
    $.post({ url:`/api/v1/situations/situations/${id}/close/`, data: payload, headers:{'X-CSRFToken': getCsrfToken()} })
      .done(()=>{ showToast('Situation clôturée.', 'success'); calendar.refetchEvents(); })
      .fail(xhr=> showToast(drfMessage(xhr,'Erreur lors de la clôture.'),'error'));
  };

  window.reopenSituation = function(id){
    $.post({ url:`/api/v1/situations/situations/${id}/reopen/`, headers:{'X-CSRFToken': getCsrfToken()} })
      .done(()=>{ showToast('Situation rouverte.', 'success'); calendar.refetchEvents(); })
      .fail(xhr=> showToast(drfMessage(xhr,'Erreur lors de la réouverture.'),'error'));
  };

  // 
  document.querySelectorAll('.toolbar-chip').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.toolbar-chip').forEach(b => b.classList.remove('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300'));
      btn.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300');
    });
  });


})();
</script>
{% endblock %}
