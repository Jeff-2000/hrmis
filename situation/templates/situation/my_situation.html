{% extends 'main/base.html' %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet" />
<style>
  .fc-event { cursor: pointer; border-radius: 6px; }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <h1 class="text-2xl font-bold text-primary uppercase flex items-center gap-2 mb-4">
    <i class="fas fa-user-shield text-primary"></i> Mes Situations Administratives
  </h1>

  <!-- Toolbar -->
  <div class="flex flex-wrap gap-3 items-end bg-base-500 p-3 rounded-lg border border-gray-200 mb-3">
    <div class="flex flex-col">
      <label class="text-xs text-gray-500 mb-1">Vue</label>
      <div class="btn-group">
        <button id="btnViewCal" class="btn btn-sm btn-active bg-blue-100 text-blue-800 hover:bg-blue-300">Calendrier</button>
        <button id="btnViewTbl" class="btn btn-sm bg-blue-100 text-blue-800 hover:bg-blue-300">Table</button>
      </div>
    </div>

    <div class="flex flex-col">
      <label class="text-xs text-gray-500 mb-1">Type</label>
      <select id="filterType" class="select select-bordered select-sm w-56 bg-blue-100 text-blue-800 border border-base-100">
        <option value="">Tous les types</option>
      </select>
    </div>

    <div class="flex flex-col">
      <label class="text-xs text-gray-500 mb-1">Statut</label>
      <div class="flex gap-2">
        <button class="btn btn-sm btn-ghost border border-base-300" data-status="">Tous</button>
        <button class="btn btn-sm btn-ghost border border-base-300" data-status="en attente">En attente</button>
        <button class="btn btn-sm btn-ghost border border-base-300" data-status="actif">Actif</button>
        <button class="btn btn-sm btn-ghost border border-base-300" data-status="terminé">Terminé</button>
      </div>
    </div>

    <div class="flex-1"></div>

    <!-- Employee can create their own situation (IsOwnProfile on API) -->
    <button id="btnNewSituation" class="btn btn-primary btn-sm">+ Nouvelle Situation</button>

    <a id="btnExportCsv" class="btn btn-sm">Exporter CSV</a>
    <button id="btnPrint" class="btn btn-sm">Imprimer</button>
  </div>

  <!-- Legend -->
  <div class="flex flex-wrap items-center gap-4 text-sm opacity-80 mb-4">
    <span><span class="badge badge-xs badge-warning mr-2">&nbsp;</span> En attente</span>
    <span><span class="badge badge-xs badge-success mr-2">&nbsp;</span> Actif</span>
    <span><span class="badge badge-xs badge-error mr-2">&nbsp;</span> Terminé</span>
    <span class="badge badge-warning badge-sm">Suspend paie</span>
  </div>

  <!-- Calendar -->
  <div id="wrapCalendar" class="block">
    <div id="calendar" class="min-h-[28rem] bg-gray-100 shadow rounded-lg border-l-4 border-primary p-4"></div>
  </div>

  <!-- Table -->
  <div id="wrapTable" class="hidden">
    <div class="overflow-x-auto bg-gray-100 shadow-xl rounded-lg border-l-4 border-blue-600">
      <table class="table w-full">
        <thead>
          <tr>
            <th class="whitespace-nowrap text-blue-600">Type</th>
            <th class="whitespace-nowrap text-blue-600">Début</th>
            <th class="whitespace-nowrap text-blue-600">Fin</th>
            <th class="whitespace-nowrap text-blue-600">Statut</th>
            <th class="whitespace-nowrap text-blue-600">Suspend</th>
            <th class="whitespace-nowrap text-blue-600">Doc</th>
            <th class="whitespace-nowrap text-right text-blue-600">Actions</th>
          </tr>
        </thead>
        <tbody id="historyTbody"></tbody>
      </table>
    </div>
    <div class="mt-3 flex items-center gap-2">
      <button id="prevPage" class="btn btn-sm">Préc</button>
      <span id="pageInfo" class="text-sm"></span>
      <button id="nextPage" class="btn btn-sm">Suiv</button>
    </div>
  </div>

  <!-- Event Modal -->
  <input type="checkbox" id="eventModal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box bg-sky-50 max-w-3xl">
      <h3 class="font-bold text-lg">Détails de la Situation</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 py-4">
        <p><strong>Employé:</strong> <span id="eventEmployee"></span></p>
        <p><strong>Type:</strong> <span id="eventSituationType"></span></p>
        <p><strong>Code:</strong> <span id="eventTypeCode"></span></p>
        <p><strong>Suspend paie:</strong> <span id="eventSuspend"></span></p>
        <p><strong>Début:</strong> <span id="eventStart"></span></p>
        <p><strong>Fin:</strong> <span id="eventEnd"></span></p>
        <p><strong>Statut:</strong> <span id="eventStatus"></span></p>
        <p><strong>Document:</strong> <span id="eventDocument"></span></p>
        <p class="md:col-span-2"><strong>Disponibilité:</strong> <span id="eventAvailabilityReason"></span></p>
        <p class="md:col-span-2"><strong>Exclusion:</strong> <span id="eventExclusionReason"></span></p>
        <p class="md:col-span-2"><strong>Sortie:</strong> <span id="eventExitType"></span></p>
      </div>

      <!-- Tranche timeline -->
      <div class="mt-3">
        <h4 class="font-semibold mb-2">Tranches</h4>
        <div id="trancheWarnings" class="text-sm text-error mb-2 hidden"></div>
        <div id="trancheTimeline" class="space-y-2"></div>
      </div>

      <div id="eventActions" class="mt-4 flex flex-wrap gap-2"></div>

      <div class="modal-action">
        <label for="eventModal" class="btn btn-secondary">Fermer</label>
      </div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <input type="checkbox" id="createEventModal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box bg-white max-w-3xl">
      <h3 class="font-bold text-lg" id="createEventModalLabel">Nouvelle Situation Administrative</h3>
      <form id="situationCreateForm" enctype="multipart/form-data" class="grid grid-cols-1 gap-4">
        {% csrf_token %}
        <!-- Employee (self) -->
        <div class="form-control">
          <label class="label"><span class="label-text">Employé</span></label>
          <div class="relative">
            <!-- Searchable (hidden for EMP; here it's always the current employee) -->
            <input
              id="employeeSearch"
              type="text"
              class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300"
              value="{{ request.user.employee.first_name }} {{ request.user.employee.last_name }}"
              readonly
            />
            <div id="employeeDropdown" class="hidden"></div>
          </div>
          <div id="employeeSelectedHint" class="mt-2 text-sm text-gray-500">Sélectionné : {{ request.user.employee.first_name }} {{ request.user.employee.last_name }}</div>
          <input type="hidden" name="employee_id" id="employeeIdInput" value="{{ request.user.employee.id|default:'' }}"/>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="label"><span class="label-text">Type</span></label>
            <select name="situation_type_id" id="situationType" class="select select-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300" required>
              <option value="" disabled selected>Sélectionner un type</option>
            </select>
          </div>
          <div> 
            <label class="label"><span class="label-text">Statut</span></label>
            <select name="status" id="statusInput" class="select select-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
              <option value="en attente" selected>En attente</option>
              <option value="actif">Actif</option>
              <option value="terminé">Terminé</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="label"><span class="label-text">Début</span></label>
            <input type="date" name="start_date" id="startDate" class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300" required>
          </div>
          <div>
            <label class="label"><span class="label-text">Fin</span></label>
            <input type="date" name="end_date" id="endDate" class="input input-bordered w-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300">
          </div>
        </div>

        <!-- Tranches -->
        <details class="bg-gray-200 rounded-lg p-3">
          <summary class="cursor-pointer font-semibold">Tranches (optionnel)</summary>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
            <div>
              <label class="label"><span class="label-text">Tranche 1 (début)</span></label>
              <input type="date" name="tranche_1_start" id="t1s" class="input input-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300">
              <label class="label mt-2"><span class="label-text">Tranche 1 (fin)</span></label>
              <input type="date" name="tranche_1_end" id="t1e" class="input input-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300">
            </div>
            <div>
              <label class="label"><span class="label-text">Tranche 2 (début)</span></label>
              <input type="date" name="tranche_2_start" id="t2s" class="input input-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300">
              <label class="label mt-2"><span class="label-text">Tranche 2 (fin)</span></label>
              <input type="date" name="tranche_2_end" id="t2e" class="input input-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300">
            </div>
            <div>
              <label class="label"><span class="label-text">Tranche 3 (début)</span></label>
              <input type="date" name="tranche_3_start" id="t3s" class="input input-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300">
              <label class="label mt-2"><span class="label-text">Tranche 3 (fin)</span></label>
              <input type="date" name="tranche_3_end" id="t3e" class="input input-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300">
            </div>
          </div>
        </details>

        <!-- Misc -->
        <details class="bg-gray-200 rounded-lg p-3">
          <summary class="cursor-pointer font-semibold">Détails complémentaires</summary>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
            <div>
              <label class="label"><span class="label-text">Disponibilité (raison)</span></label>
              <textarea name="availability_reason" id="availabilityReason" class="textarea textarea-bordered bg-white w-full"></textarea>
            </div>
            <div>
              <label class="label"><span class="label-text">Exclusion (raison)</span></label>
              <textarea name="exclusion_reason" id="exclusionReason" class="textarea textarea-bordered bg-white w-full"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="label"><span class="label-text">Type de sortie</span></label>
              <input type="text" name="exit_type" id="exitType" class="input input-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300">
            </div>
          </div>
        </details>

        <!-- Document -->
        <details class="bg-gray-200 rounded-lg p-3">
          <summary class="cursor-pointer font-semibold">Justificatif</summary>
          <div class="mt-3">
            <div class="relative border-2 border-dashed border-base-300 hover:border-white rounded-lg p-4 bg-blue-200 hover:bg-blue-300 transition-colors" id="dropZone">
              <input type="file" name="document_file" id="documentInput"
                     class="file-input file-input-bordered w-full opacity-0 absolute inset-0 cursor-pointer"
                     accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
              <div class="text-center opacity-80 pointer-events-none">
                <i class="fas fa-upload text-primary text-2xl mb-2"></i>
                <p id="dropZoneText">Glissez & déposez un fichier ici ou cliquez…</p>
              </div>
            </div>
            <p id="fileName" class="text-sm text-gray-500 mt-2"></p>

            <div id="documentDetails" class="grid grid-cols-1 gap-4 mt-4 hidden">
              <div>
                <label class="label"><span class="label-text">Type de Document</span></label>
                <select name="document_type" id="documentType" class="select select-bordered w-full">
                  <option value="" disabled selected>Sélectionner un type</option>
                  <option value="arrete">Arrêté</option>
                  <option value="certificat_medical">Certificat Médical</option>
                  <option value="contrat">Contrat</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              <div>
                <label class="label"><span class="label-text">Date d'Émission</span></label>
                <input type="date" name="issuance_date" id="issuanceDate" class="input input-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300">
              </div>
              <div>
                <label class="label"><span class="label-text">Émis Par</span></label>
                <input type="text" name="issued_by" id="issuedBy" class="input input-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300">
              </div>
              <div>
                <label class="label"><span class="label-text">Note (facultatif)</span></label>
                <textarea name="content_text" id="contentText" class="textarea textarea-bordered w-full"></textarea>
              </div>
            </div>
          </div>
        </details>

        <div id="formErrors" class="alert alert-error hidden">
          <ul id="errorList" class="list-disc pl-5"></ul>
        </div>

        <div class="modal-action">
          <label for="createEventModal" class="btn btn-secondary">Annuler</label>
          <button class="btn btn-primary" id="submitSituationRequest">Soumettre</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Replace Document Modal -->
  <input type="checkbox" id="replaceDocModal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box bg-sky-100 max-w-xl">
      <h3 class="font-bold text-lg">Remplacer le document</h3>
      <form id="replaceDocForm" class="space-y-3">
        <div class="form-control">
          <label class="label"><span class="label-text">Fichier</span></label>
          <input type="file" id="replaceDocFile" class="file-input file-input-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="label"><span class="label-text">Type</span></label>
            <select id="replaceDocType" class="select select-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300" required>
              <option value="" disabled selected>Sélectionner</option>
              <option value="arrete">Arrêté</option>
              <option value="certificat_medical">Certificat Médical</option>
              <option value="contrat">Contrat</option>
              <option value="autre">Autre</option>
            </select>
          </div>
          <div>
            <label class="label"><span class="label-text">Date d'Émission</span></label>
            <input type="date" id="replaceDocIssuance" class="input input-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300" required>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="label"><span class="label-text">Émis par</span></label>
            <input type="text" id="replaceDocIssuedBy" class="input input-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300" required>
          </div>
          <div>
            <label class="label"><span class="label-text">Note (facultatif)</span></label>
            <input type="text" id="replaceDocNote" class="input input-bordered w-full bg-white focus:outline-none focus:ring-2 focus:ring-gray-300">
          </div>
        </div>
        <div class="modal-action">
          <label for="replaceDocModal" class="btn btn-secondary">Annuler</label>
          <button class="btn btn-primary" id="confirmReplaceDoc">Remplacer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirm Modal -->
  <input type="checkbox" id="confirmModal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box bg-sky-100 max-w-md">
      <h3 class="font-bold text-lg" id="confirmTitle">Confirmer</h3>
      <p class="py-4" id="confirmMessage">Êtes-vous sûr ?</p>
      <div class="modal-action">
        <label for="confirmModal" class="btn btn-ghost">Annuler</label>
        <button class="btn btn-error" id="confirmYes">Oui</button>
      </div>
    </div>
  </div>

  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2 w-full max-w-xs pointer-events-none"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/locales-all.global.min.js"></script>
<script>
(function(){
  const ROLE = "{{ request.user.role|default:'' }}".trim().toUpperCase();
  const userId = "{{ request.user.id|default:'' }}";
  const employeeId = "{{ request.user.employee.id|default:'' }}";

  function getCsrfToken(){ const c=document.cookie.split('; ').find(r=>r.startsWith('csrftoken=')); return c?c.split('=')[1]:''; }
  const fmt = d => moment(d).format('YYYY-MM-DD');

  const state = { status:"", typeId:"", page:1, pageSize:10 };

  // ===========================
  // Helpers
  // ===========================
  function showToast(message, type='error'){
    const toastContainer=document.getElementById('toastContainer');
    const toast=document.createElement('div');
    const types={ error:{bg:'bg-red-100',text:'text-red-800',border:'border-red-600',icon:'fa-exclamation-circle text-red-600'},
                  success:{bg:'bg-green-100',text:'text-green-800',border:'border-green-600',icon:'fa-check-circle text-green-600'} };
    const t=types[type]||types.error;
    toast.className=`toast ${t.bg} ${t.text} border-l-4 ${t.border} p-4 rounded-md shadow-lg flex items-start pointer-events-auto mb-2`;
    toast.innerHTML=`<i class="fas ${t.icon} mt-1 mr-3"></i><div class="flex-1"><p class="text-sm font-medium">${message}</p></div><button class="ml-2 opacity-60 hover:opacity-100" onclick="this.closest('.toast').remove()"><i class="fas fa-times"></i></button>`;
    toastContainer.appendChild(toast);
    setTimeout(()=>{ toast.classList.add('hide'); toast.addEventListener('animationend', ()=>toast.remove(), { once:true }); }, 5000);
  }
  function drfMessage(xhr, fallback='Une erreur est survenue'){
    try{
      const data = xhr?.responseJSON || (xhr?.responseText ? JSON.parse(xhr.responseText) : null);
      if (!data) return fallback;
      if (typeof data === 'string') return data;
      if (data.detail) return data.detail;
      const lines=[]; for (const [k,v] of Object.entries(data)){ if (v==null) continue; if (Array.isArray(v)) lines.push(`${k}: ${v.join(', ')}`); else if (typeof v==='object') lines.push(`${k}: ${JSON.stringify(v)}`); else lines.push(`${k}: ${v}`); }
      return lines.join('<br>') || fallback;
    }catch{ return fallback; }
  }

  function eventContent(arg){
    const st=arg.event.extendedProps.situation_type||{};
    const status=String(arg.event.extendedProps.status||'').toLowerCase();
    const wrap=document.createElement('div');

    const title=document.createElement('div');
    title.textContent=arg.event.title;
    title.className='font-semibold text-xs';

    const pills=document.createElement('div');
    pills.className='flex flex-wrap gap-1 mt-0.5';

    const mk=(label,classes)=>{ const b=document.createElement('span'); b.className=`badge badge-sm ${classes}`; b.textContent=label; return b; };

    if (status==='en attente') pills.appendChild(mk('EN ATTENTE','badge-warning'));
    else if (status==='actif') pills.appendChild(mk('ACTIF','badge-success'));
    else if (status==='terminé') pills.appendChild(mk('TERMINÉ','badge-error'));
    if (st.suspend_payroll) pills.appendChild(mk('SUSPEND PAIE','badge-warning'));
    if (st.code) pills.appendChild(mk(st.code.toUpperCase(),'badge-ghost'));

    wrap.appendChild(title); wrap.appendChild(pills);
    return { domNodes:[wrap] };
  }

  function pickDocUrl(obj){ if(!obj) return null; return obj.file?.url || obj.file_url || obj.url || (typeof obj.file==='string' ? obj.file : null); }
  function pickDocLabel(obj){ if(!obj) return null; return obj.original_name || obj.filename || obj.name || (typeof obj.file==='string' ? obj.file.split('/').pop() : null); }
  async function extractDocLink(detail){
    if(!detail) return null;
    let docObj = detail.document_detail || (typeof detail.document==='object' ? detail.document : null) || null;
    let docId  = (typeof detail.document==='number') ? detail.document : (docObj?.id || null);
    let href   = pickDocUrl(docObj) || detail.document_file || null;
    let label  = pickDocLabel(docObj);
    if (!href && docId){
      try{
        const doc = await $.getJSON(`/api/v1/documents/${docId}/`);
        href  = pickDocUrl(doc) || doc?.file || doc?.url || href;
        label = label || pickDocLabel(doc);
      }catch(_){}
    }
    if (href && !/^https?:\/\//.test(href) && !href.startsWith('/')) href = '/' + href;
    if (!label && href){ try{ label=decodeURIComponent(href.split('/').pop()); }catch{ label=href.split('/').pop(); } }
    return href ? { href, label } : null;
  }
  async function renderDocumentLink(eventId){
    const el = document.getElementById('eventDocument'); if(!el) return;
    el.textContent = 'Chargement...';
    try{
      const detail = await $.getJSON(`/api/v1/situations/situations/${eventId}/`);
      const link = await extractDocLink(detail);
      el.innerHTML = link ? `<a href="${link.href}" target="_blank" rel="noopener" class="link link-primary">${link.label || 'Voir le document'}</a>` : 'Aucun';
    }catch(_){ el.textContent = 'Aucun'; }
  }

  function renderTranches(data){
    const host = $('#trancheTimeline').empty();
    const warn = $('#trancheWarnings').addClass('hidden').empty();
    const start = data.start_date, end = data.end_date || null;
    let problems = [];
    for (let i=1;i<=3;i++){
      const s = data[`tranche_${i}_start`], e = data[`tranche_${i}_end`];
      if (!s && !e) continue;
      if ((s && !e) || (e && !s)) problems.push(`Tranche ${i}: dates incomplètes.`);
      if (s && e && s > e) problems.push(`Tranche ${i}: début après fin.`);
      if (s && start && s < start) problems.push(`Tranche ${i}: début < début de la situation.`);
      if (e && end && e > end) problems.push(`Tranche ${i}: fin > fin de la situation.`);
      host.append(`<div class="flex items-center gap-2 text-sm"><span class="badge badge-info badge-xs"></span> <strong>Tranche ${i}</strong> — ${s||'—'} → ${e||'—'}</div>`);
    }
    if (problems.length){
      warn.removeClass('hidden').html(problems.map(x=>`• ${x}`).join('<br/>'));
    }
  }

  // ===========================
  // Form support
  // ===========================
  function loadTypes() {
    $.get('/api/v1/situation-types/', data => {
      const list = (data.results || data);
      // toolbar
      const fSel = $('#filterType').empty().append('<option value="">Tous les types</option>');
      list.forEach(x => fSel.append(`<option value="${x.id}">${x.name}</option>`));
      // form
      const sSel = $('#situationType').empty().append('<option value="" disabled selected>Sélectionner un type</option>');
      list.forEach(x => sSel.append(`<option value="${x.id}" data-code="${x.code}" data-suspend="${x.suspend_payroll}">${x.name}</option>`));
    });
  }

  // Document UI in create modal
  const dropZone = document.getElementById('dropZone');
  const documentInput = document.getElementById('documentInput');
  const dropZoneText = document.getElementById('dropZoneText');
  const fileNameDisplay = document.getElementById('fileName');
  const documentDetails = document.getElementById('documentDetails');

  function updateDocumentUI(){
    const f=documentInput.files?.[0];
    fileNameDisplay.textContent = f ? `Fichier sélectionné : ${f.name}` : '';
    documentDetails.classList.toggle('hidden', !f);
  }
  if (dropZone){
    dropZone.addEventListener('dragover', e=>{ e.preventDefault(); dropZone.classList.add('border-primary'); dropZoneText.textContent='Relâchez pour déposer'; });
    dropZone.addEventListener('dragleave', e=>{ e.preventDefault(); dropZone.classList.remove('border-primary'); dropZoneText.textContent='Glissez & déposez un fichier…'; });
    dropZone.addEventListener('drop', e=>{ e.preventDefault(); dropZone.classList.remove('border-primary'); dropZoneText.textContent='Glissez & déposez un fichier…'; if (e.dataTransfer?.files?.length){ documentInput.files = e.dataTransfer.files; updateDocumentUI(); } });
  }
  if (documentInput){ documentInput.addEventListener('change', updateDocumentUI); }

  async function fetchSituationContentType(){
    try{
      const resp = await fetch('/api/v1/contenttypes/', { headers:{'X-Requested-With':'XMLHttpRequest'}, credentials:'same-origin' });
      const data = await resp.json();
      const items = data.results || data;
      const ct = items.find(ct => ct.model === 'situation' && (ct.app_label === 'situation' || ct.app_label === 'situations'));
      return ct?.id || null;
    }catch{ return null; }
  }

  async function uploadDocumentForSituation(file, payloadExtra={}){
    if (!file) return null;
    const ctId = await fetchSituationContentType();
    if (!ctId){ showToast("Impossible d'obtenir le ContentType pour Situation.", 'error'); return null; }
    const fd = new FormData();
    fd.append('file', file);
    fd.append('document_type', payloadExtra.document_type || 'autre');
    if (payloadExtra.issuance_date) fd.append('issuance_date', payloadExtra.issuance_date);
    if (payloadExtra.issued_by)     fd.append('issued_by', payloadExtra.issued_by);
    if (payloadExtra.content_text)  fd.append('content_text', payloadExtra.content_text);
    fd.append('status', 'to_validate');
    // some backends require these even if not used later
    fd.append('content_type', ctId);
    fd.append('object_id', '1');
    try{
      const docResp = await $.ajax({
        url: '/api/v1/documents/', type:'POST', data: fd, processData:false, contentType:false,
        headers: { 'X-CSRFToken': getCsrfToken() }
      });
      return docResp?.id || null;
    }catch(err){
      showToast(drfMessage(err, 'Erreur lors du téléversement du document.'), 'error');
      return null;
    }
  }

  // ===========================
  // Ownership + permissions
  // ===========================
  function isOwnerFromEvent(ev){
    const emp = ev?.extendedProps?.employee || {};
    return (
      String(emp?.user?.id ?? '') === String(userId) ||
      String(ev?.extendedProps?.employee_user_id ?? '') === String(userId) ||
      String(emp?.id ?? '') === String(employeeId) ||
      String(ev?.extendedProps?.employee_id ?? '') === String(employeeId)
    );
  }
  function canEmpEditOrDelete(ev){
    const status = String(ev?.extendedProps?.status||'').toLowerCase();
    const startsInFuture = moment(ev.start).startOf('day').isAfter(moment().startOf('day'));
    return ROLE === 'EMP' && isOwnerFromEvent(ev) && status === 'en attente' && startsInFuture;
  }

  // ===========================
  // Calendar
  // ===========================
  function toEvent(item){
    const emp = item.employee || {};
    const st  = item.situation_type || {};
    const endExclusive = item.end_date ? moment(item.end_date).add(1,'day').format('YYYY-MM-DD') : null;
    return {
      id: item.id,
      title: (st.name ? st.name : 'Situation'),
      start: item.start_date,
      end: endExclusive,
      allDay: true,
      extendedProps: {
        employee: emp,
        employee_id: item.employee_id || emp.id,
        employee_user_id: (emp.user && emp.user.id) || null,
        situation_type: st,
        status: item.status,
        document: item.document,
        availability_reason: item.availability_reason,
        exclusion_reason: item.exclusion_reason,
        exit_type: item.exit_type
      }
    };
  }

  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'fr',
    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
    selectable: true,                 // selecting creates (for self)
    editable: true,                   // drag/drop allowed, but eventAllow gate keeps
    height: 'auto',
    expandRows: true,
    events: function(info, success, failure){
      const start = fmt(info.start), end = fmt(info.end);
      const params = new URLSearchParams();
      params.set('date_range', `${start} to ${end}`);
      params.set('employee_id', employeeId);
      // show both current and near; do not apply 'active' hard filter here so you can see any overlapping
      if (state.status) params.set('status', state.status);
      if (state.typeId) params.set('situation_type_id', state.typeId);
      fetch(`/api/v1/situations/situations/?${params.toString()}`, { headers:{'X-Requested-With':'XMLHttpRequest'} })
        .then(r=>r.json()).then(data=> success((data.results||data||[]).map(toEvent)))
        .catch(err=>{ console.error(err); failure(err); showToast('Erreur de chargement.', 'error'); });
    },
    eventContent,
    eventAllow: function(dropInfo, draggedEvent){
      return canEmpEditOrDelete(draggedEvent) &&
             moment(dropInfo.start).startOf('day').isAfter(moment().startOf('day'));
    },
    eventDrop: function(info){
      if (!canEmpEditOrDelete(info.event)){ info.revert(); return; }
      const payload = {
        start_date: moment(info.event.start).format('YYYY-MM-DD'),
        end_date: info.event.end ? moment(info.event.end).subtract(1, 'days').format('YYYY-MM-DD') : null
      };
      $.ajax({
        url: `/api/v1/situations/situations/${info.event.id}/`,
        type: 'PATCH',
        data: JSON.stringify(payload),
        contentType: 'application/json',
        headers: { 'X-CSRFToken': getCsrfToken() }
      }).done(()=>{ showToast('Dates mises à jour.', 'success'); calendar.refetchEvents(); })
        .fail(xhr=>{ showToast(drfMessage(xhr,'Erreur lors de la mise à jour.'), 'error'); info.revert(); });
    },
    select: function(info){
      // new situation (self)
      $('#situationCreateForm')[0].reset();
      $('#employeeIdInput').val(employeeId);
      $('#employeeSearch').val(`{{ request.user.employee.first_name }} {{ request.user.employee.last_name }}`);
      $('#employeeSelectedHint').text(`Sélectionné : {{ request.user.employee.first_name }} {{ request.user.employee.last_name }}`);
      $('#startDate').val(fmt(info.start));
      $('#endDate').val(info.end ? moment(info.end).subtract(1,'days').format('YYYY-MM-DD') : '');
      $('#createEventModalLabel').text('Nouvelle Situation Administrative');
      $('#submitSituationRequest').removeData('id').text('Soumettre');
      document.getElementById('createEventModal').checked = true;
    },
    eventClick: function(info){
      const st  = info.event.extendedProps.situation_type || {};
      const emp = info.event.extendedProps.employee || {};
      $('#eventEmployee').text(`${emp.first_name||''} ${emp.last_name||''}`.trim()||'Moi');
      $('#eventSituationType').text(st.name || '—');
      $('#eventTypeCode').text(st.code || '—');
      $('#eventSuspend').text(st.suspend_payroll ? 'Oui' : 'Non');
      $('#eventStart').text(moment(info.event.start).format('YYYY-MM-DD'));
      $('#eventEnd').text(info.event.end ? moment(info.event.end).subtract(1,'days').format('YYYY-MM-DD') : '—');
      $('#eventStatus').text((info.event.extendedProps.status || '').toUpperCase());
      $('#eventAvailabilityReason').text(info.event.extendedProps.availability_reason || '—');
      $('#eventExclusionReason').text(info.event.extendedProps.exclusion_reason || '—');
      $('#eventExitType').text(info.event.extendedProps.exit_type || '—');
      renderDocumentLink(info.event.id);

      $.get(`/api/v1/situations/situations/${info.event.id}/`, data => renderTranches(data));

      const actions = [];
      if (canEmpEditOrDelete(info.event)) {
        actions.push(`<button class="btn btn-warning btn-sm" onclick="editSituation(${info.event.id})">Modifier</button>`);
        actions.push(`<button class="btn btn-error btn-sm" onclick="askDelete(${info.event.id})">Supprimer</button>`);
        actions.push(`<label for="replaceDocModal" class="btn btn-sm" onclick="prepReplace(${info.event.id})">Remplacer document</label>`);
      }
      $('#eventActions').html(actions.join(' '));
      document.getElementById('eventModal').checked = true;
    }
  });
  calendar.render();

  // ===========================
  // Table (history for self)
  // ===========================
  function loadTable(){
    const params = new URLSearchParams();
    params.set('page', state.page);
    params.set('page_size', state.pageSize);
    params.set('employee_id', employeeId);
    if (state.status) params.set('status', state.status);
    if (state.typeId) params.set('situation_type_id', state.typeId);

    $.get(`/api/v1/situations/situations/?${params.toString()}`, data=>{
      const results = data.results || data;
      const tbody = $('#historyTbody').empty();
      results.forEach(row=>{
        const st=row.situation_type||{};
        const hasDoc = !!row.document;
        let docHref = '';
        let docLabel = '';
        if (row.document){
          docHref = row.document.file?.url || row.document.url || '';
          if (docHref && !/^https?:\/\//.test(docHref) && !docHref.startsWith('/')) docHref = '/' + docHref;
          docLabel = row.document.original_name || row.document.filename || 'doc';
        }
        tbody.append(`<tr>
          <td>${st.name||'—'}</td>
          <td>${row.start_date||'—'}</td>
          <td>${row.end_date||'—'}</td>
          <td>${(row.status||'').toUpperCase()}</td>
          <td>${st.suspend_payroll?'Oui':'Non'}</td>
          <td>${hasDoc ? `<a href="${docHref}" target="_blank" rel="noopener" class="link link-primary">${docLabel}</a>` : '—'}</td>
          <td class="text-right">
            ${row.status==='en attente' && moment(row.start_date).isAfter(moment(),'day') ? `
              <button class="btn btn-xs btn-warning" onclick="editSituation(${row.id})">Modifier</button>
              <button class="btn btn-xs btn-error" onclick="askDelete(${row.id})">Supprimer</button>
            ` : ''}
            <button class="btn btn-xs" onclick="viewSituation(${row.id})">Voir</button>
          </td>
        </tr>`);
      });
      $('#pageInfo').text(data.count ? `Page ${state.page} — ${data.count} éléments` : `Page ${state.page}`);
    });
  }

  window.viewSituation = function(id){
    $.get(`/api/v1/situations/situations/${id}/`, data=>{
      const st=data.situation_type||{}; const emp=data.employee||{};
      $('#eventEmployee').text(`${emp.first_name||''} ${emp.last_name||''}`.trim()||'Moi');
      $('#eventSituationType').text(st.name||'—');
      $('#eventTypeCode').text(st.code||'—');
      $('#eventSuspend').text(st.suspend_payroll?'Oui':'Non');
      $('#eventStart').text(data.start_date||'—');
      $('#eventEnd').text(data.end_date||'—');
      $('#eventStatus').text((data.status||'').toUpperCase());
      $('#eventAvailabilityReason').text(data.availability_reason || '—');
      $('#eventExclusionReason').text(data.exclusion_reason || '—');
      $('#eventExitType').text(data.exit_type || '—');
      renderTranches(data);
      renderDocumentLink(id);
      document.getElementById('eventModal').checked = true;
    });
  }

  // ===========================
  // Toolbar wiring
  // ===========================
  loadTypes();

  // Status chips
  document.querySelectorAll('[data-status]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('[data-status]').forEach(b=> b.classList.remove('btn-active'));
      btn.classList.add('btn-active');
      state.status = btn.dataset.status || '';
      if ($('#wrapCalendar').is(':visible')) calendar.refetchEvents(); else loadTable();
    });
  });

  $(document).on('click', '.status-chip', function(){
    $('.status-chip').removeClass('btn-active bg-blue-400 text-white'); // reset all
    $(this).addClass('btn-active bg-blue-400 text-white'); // active button
    state.status=this.dataset.status||'';
    refresh();
  });

  $('#filterType').on('change', function(){ state.typeId=this.value; if ($('#wrapCalendar').is(':visible')) calendar.refetchEvents(); else loadTable(); });

  $('#btnViewCal').on('click', function(){
    $('#wrapCalendar').removeClass('hidden').addClass('block');
    $('#wrapTable').addClass('hidden');
    $(this).addClass('btn-active'); $('#btnViewTbl').removeClass('btn-active');
    calendar.refetchEvents();
  });
  $('#btnViewTbl').on('click', function(){
    $('#wrapTable').removeClass('hidden'); $('#wrapCalendar').addClass('hidden');
    $(this).addClass('btn-active'); $('#btnViewCal').removeClass('btn-active');
    loadTable();
  });

  $('#prevPage').on('click', function(){ if (state.page>1){ state.page--; loadTable(); } });
  $('#nextPage').on('click', function(){ state.page++; loadTable(); });

  $('#btnExportCsv').on('click', function(e){
    e.preventDefault();
    const params = new URLSearchParams();
    params.set('employee_id', employeeId);
    if (state.status) params.set('status', state.status);
    if (state.typeId) params.set('situation_type_id', state.typeId);
    window.location.href = `/api/v1/situations/situations/export_csv/?${params.toString()}`;
  });

  $('#btnPrint').on('click', function(){
    // Ensure table view is loaded
    if ($('#wrapTable').hasClass('hidden')){ $('#btnViewTbl').click(); }
    setTimeout(()=>{
      const w=window.open('', '_blank');
      w.document.write('<html><head><title>Impression</title><meta charset="utf-8"/></head><body>');
      w.document.write(document.getElementById('wrapTable').innerHTML);
      w.document.write('</body></html>'); w.document.close(); w.focus(); w.print(); w.close();
    }, 150);
  });

  $('#btnNewSituation').on('click', function(){
    $('#situationCreateForm')[0].reset();
    $('#employeeIdInput').val(employeeId);
    $('#employeeSearch').val(`{{ request.user.employee.first_name }} {{ request.user.employee.last_name }}`);
    $('#employeeSelectedHint').text(`Sélectionné : {{ request.user.employee.first_name }} {{ request.user.employee.last_name }}`);
    $('#createEventModalLabel').text('Nouvelle Situation Administrative');
    $('#submitSituationRequest').removeData('id').text('Soumettre');
    document.getElementById('createEventModal').checked = true;
  });

  // ===========================
  // Create / Update submit
  // ===========================
  $('#submitSituationRequest').on('click', async function(e){
    e.preventDefault();
    const id   = $(this).data('id');
    const url  = id ? `/api/v1/situations/situations/${id}/` : '/api/v1/situations/situations/';
    const method = id ? 'PATCH' : 'POST';

    const formEl  = $('#situationCreateForm')[0];
    const fd = new FormData(formEl);

    const stVal = $('#situationType').val();
    if (!stVal){ showToast('Veuillez sélectionner un type.', 'error'); return; }
    fd.set('situation_type_id', stVal);
    fd.set('employee_id', $('#employeeIdInput').val() || employeeId);

    // client-side check start <= end
    const s = $('#startDate').val(), eDate = $('#endDate').val();
    if (s && eDate && s > eDate){
      $('#formErrors').removeClass('hidden'); $('#errorList').html('<li>La date de fin doit être postérieure à la date de début.</li>'); return;
    } else { $('#formErrors').addClass('hidden'); $('#errorList').empty(); }

    try{
      const file = documentInput?.files?.[0];
      if (file){
        // Require doc details for your backend
        const docType = $('#documentType').val();
        const issuance = $('#issuanceDate').val();
        const issuedBy = $('#issuedBy').val();
        if (!docType || !issuance || !issuedBy){
          $('#formErrors').removeClass('hidden'); $('#errorList').html('<li>Type, date d’émission et émetteur du document sont requis.</li>'); return;
        }
        const docId = await uploadDocumentForSituation(file, {
          document_type: docType, issuance_date: issuance, issued_by: issuedBy, content_text: $('#contentText').val() || ''
        });
        if (docId) fd.set('document_id', docId); else return;
      }

      await $.ajax({ url, type: method, data: fd, processData:false, contentType:false, headers:{'X-CSRFToken': getCsrfToken()} });
      showToast('Situation enregistrée avec succès.', 'success');
      $('#createEventModal').prop('checked', false);
      calendar.refetchEvents();
      if (!$('#wrapCalendar').hasClass('hidden')) { /* ok */ } else { loadTable(); }
    }catch(xhr){
      showToast(drfMessage(xhr,'Vérifiez les champs requis'), 'error');
    }
  });

  // ===========================
  // Edit / Delete / Replace Doc
  // ===========================
  window.editSituation = function(id){
    $.get(`/api/v1/situations/situations/${id}/`, data => {
      // Always self; but set hint from data anyway
      $('#employeeIdInput').val(employeeId);
      $('#employeeSearch').val(`${data.employee?.first_name||''} ${data.employee?.last_name||''}`.trim());
      $('#employeeSelectedHint').text(`Sélectionné : ${$('#employeeSearch').val()}`);

      $('#situationType').val(data.situation_type?.id).trigger('change');
      $('#statusInput').val(data.status);
      $('#startDate').val(data.start_date);
      $('#endDate').val(data.end_date || '');
      $('#t1s').val(data.tranche_1_start||''); $('#t1e').val(data.tranche_1_end||'');
      $('#t2s').val(data.tranche_2_start||''); $('#t2e').val(data.tranche_2_end||'');
      $('#t3s').val(data.tranche_3_start||''); $('#t3e').val(data.tranche_3_end||'');
      $('#availabilityReason').val(data.availability_reason || '');
      $('#exclusionReason').val(data.exclusion_reason || '');
      $('#exitType').val(data.exit_type || '');

      $('#createEventModalLabel').text('Modifier la Situation Administrative');
      $('#submitSituationRequest').data('id', id).text('Mettre à jour');
      document.getElementById('createEventModal').checked = true;
    }).fail(xhr => showToast(drfMessage(xhr,'Erreur lors du chargement.'),'error'));
  };

  function openConfirm({title, message, onConfirm}){
    $('#confirmTitle').text(title||'Confirmer');
    $('#confirmMessage').html(message||'Êtes-vous sûr ?');
    $('#confirmYes').off('click').on('click', function(){
      document.getElementById('confirmModal').checked = false;
      onConfirm && onConfirm();
    });
    document.getElementById('confirmModal').checked = true;
  }

  window.askDelete = function(id){
    openConfirm({
      title: 'Supprimer',
      message: 'Supprimer cette situation ?',
      onConfirm: function(){
        $.ajax({ url:`/api/v1/situations/situations/${id}/`, type:'DELETE', headers:{'X-CSRFToken': getCsrfToken()} })
          .done(()=>{ calendar.refetchEvents(); loadTable(); document.getElementById('eventModal').checked=false; showToast('Situation supprimée.', 'success'); })
          .fail(xhr=> showToast(drfMessage(xhr,'Erreur lors de la suppression.'), 'error'));
      }
    });
  };

  let _replaceTargetId = null;
  window.prepReplace = function(id){
    _replaceTargetId = id;
    // reset form
    $('#replaceDocForm')[0].reset();
  };
  $('#confirmReplaceDoc').on('click', async function(e){
    e.preventDefault();
    const file = document.getElementById('replaceDocFile').files[0];
    const docType = $('#replaceDocType').val();
    const issuance = $('#replaceDocIssuance').val();
    const issuedBy = $('#replaceDocIssuedBy').val();
    const note = $('#replaceDocNote').val();

    if (!file || !docType || !issuance || !issuedBy){
      showToast('Fichier, type, date d’émission et émetteur requis.', 'error'); return;
    }
    const docId = await uploadDocumentForSituation(file, { document_type: docType, issuance_date: issuance, issued_by: issuedBy, content_text: note });
    if (!docId) return;

    try{
      await $.post({ url:`/api/v1/situations/situations/${_replaceTargetId}/attach_document/`, data:{document_id: docId}, headers:{'X-CSRFToken': getCsrfToken()} });
      showToast('Document remplacé.', 'success');
      document.getElementById('replaceDocModal').checked = false;
      renderDocumentLink(_replaceTargetId);
      calendar.refetchEvents();
      loadTable();
    }catch(err){
      showToast(drfMessage(err,'Échec du remplacement.'),'error');
    }
  });

})();
</script>
{% endblock %}
