{% extends 'main/base.html' %}
{% block title %}Paramètres Paie — Cotisations{% endblock %}

{% block content %}
<div class="container mx-auto">
  <div class="card bg-white shadow-xl border-l-4 border-orange-600">
    <div class="card-body">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-orange-600 flex items-center gap-2"><i class="fas fa-hand-holding-dollar"></i> Schémas de Cotisations</h1>
        <button id="btnNew" class="btn bg-orange-600 hover:bg-orange-700 text-white"><i class="fas fa-plus mr-2"></i>Nouveau</button>
      </div>

      <div class="overflow-x-auto mt-4">
        <table class="table w-full">
          <thead><tr>
            <th class="whitespace-nowrap text-blue-600">Code</th>
            <th class="whitespace-nowrap text-blue-600">Nom</th>
            <th class="whitespace-nowrap text-blue-600">EE %</th>
            <th class="whitespace-nowrap text-blue-600">ER %</th>
            <th class="whitespace-nowrap text-blue-600">Plafond</th>
            <th class="whitespace-nowrap text-blue-600">Inclure primes taxables</th>
            <th class="whitespace-nowrap text-blue-600">Valide du</th>
            <th class="whitespace-nowrap text-blue-600">au</th>
            <th class="whitespace-nowrap text-blue-600 text-right">Actions</th>
          </tr></thead>
          <tbody id="tbody"><tr><td colspan="9" class="text-center text-base-gray">Chargement…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<input type="checkbox" id="editModal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box bg-white border-l-4 border-orange-600">
    <h3 class="font-bold text-lg" id="modalTitle">Nouveau Schéma</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div><label class="label"><span class="label-text">Code</span></label><input id="f_code" class="input input-bordered w-full border-blue-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 bg-white text-blue-800"></div>
      <div><label class="label"><span class="label-text">Nom</span></label><input id="f_name" class="input input-bordered w-full border-blue-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 bg-white text-blue-800"></div>
      <div><label class="label"><span class="label-text">EE %</span></label><input id="f_ee" type="number" step="0.0001" class="input input-bordered w-full border-blue-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 bg-white text-blue-800"></div>
      <div><label class="label"><span class="label-text">ER %</span></label><input id="f_er" type="number" step="0.0001" class="input input-bordered w-full border-blue-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 bg-white text-blue-800"></div>
      <div><label class="label"><span class="label-text">Plafond</span></label><input id="f_cap" type="number" step="0.01" class="input input-bordered w-full border-blue-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 bg-white text-blue-800"></div>
      <div class="flex items-center gap-2 mt-8">
        <input id="f_inc" type="checkbox" class="checkbox checkbox-primary" checked><span>Inclure primes taxables</span>
      </div>
      <div><label class="label"><span class="label-text">Valide du</span></label><input id="f_from" type="date" class="input input-bordered w-full border-blue-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 bg-white text-blue-800"></div>
      <div><label class="label"><span class="label-text">au</span></label><input id="f_to" type="date" class="input input-bordered w-full border-blue-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 bg-white text-blue-800"></div>
    </div>
    <div class="modal-action">
      <label for="editModal" class="btn btn-ghost">Annuler</label>
      <button id="btnSave" class="btn bg-orange-600 hover:bg-orange-700 text-white">Enregistrer</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  function getCsrf(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; }
  let editId=null;
  async function load(){
    const r=await fetch('/api/v1/contribs/?page_size=999'); const d=await r.json(); const rows=d.results||d||[];
    if(!rows.length){ tbody.innerHTML=`<tr><td colspan="9" class="text-center text-base-content/60">Aucun</td></tr>`; return; }
    tbody.innerHTML = rows.map(x=>`<tr>
      <td>${x.code}</td><td>${x.name}</td><td>${x.ee_rate}</td><td>${x.er_rate}</td>
      <td>${x.cap||'—'}</td><td>${x.include_taxable_allowances?'Oui':'Non'}</td>
      <td>${x.valid_from}</td><td>${x.valid_to||'—'}</td>
      <td class="text-right">
        <button class="btn btn-xs bg-orange-500" data-edit="${x.id}"><i class="fas fa-edit"></i></button>
        <button class="btn btn-xs btn-error text-white" data-del="${x.id}"><i class="fas fa-trash"></i></button>
      </td>
    </tr>`).join('');
    tbody.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click',()=>openEdit(b.dataset.edit)));
    tbody.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>doDelete(b.dataset.del)));
  }
  function openEdit(id){
    editId=id||null; modalTitle.textContent=id?'Modifier Schéma':'Nouveau Schéma';
    f_code.value=''; f_name.value=''; f_ee.value=''; f_er.value=''; f_cap.value=''; f_from.value=''; f_to.value=''; f_inc.checked=true;
    if(id){
      fetch('/api/v1/contribs/'+id+'/').then(r=>r.json()).then(x=>{
        f_code.value=x.code; f_name.value=x.name; f_ee.value=x.ee_rate; f_er.value=x.er_rate;
        f_cap.value=x.cap||''; f_inc.checked=!!x.include_taxable_allowances;
        f_from.value=x.valid_from||''; f_to.value=x.valid_to||'';
        editModal.checked=true;
      });
    } else editModal.checked=true;
  }
  async function doSave(){
    const payload={
      code:f_code.value.trim(), name:f_name.value.trim(),
      ee_rate:Number(f_ee.value||0), er_rate:Number(f_er.value||0),
      valid_from:f_from.value||null, valid_to:f_to.value||null,
      cap: f_cap.value? Number(f_cap.value): null,
      include_taxable_allowances: f_inc.checked
    };
    if(!payload.code || !payload.name || !payload.valid_from){ showToast('Code, nom et date début requis','error'); return; }
    const url= editId? `/api/v1/contribs/${editId}/` : '/api/v1/contribs/';
    const method= editId? 'PUT':'POST';
    const r=await fetch(url,{method,headers:{'Content-Type':'application/json','X-CSRFToken':getCsrf()},body:JSON.stringify(payload)});
    if(!r.ok){ const e=await r.json().catch(()=>({detail:'Erreur'})); showToast(e.detail||JSON.stringify(e),'error'); return; }
    editModal.checked=false; showToast('Enregistré','success'); load();
  }
  async function doDelete(id){
    if(!confirm('Supprimer ce schéma ?')) return;
    const r=await fetch(`/api/v1/contribs/${id}/`,{method:'DELETE',headers:{'X-CSRFToken':getCsrf()}});
    if(!r.ok){ showToast('Suppression impossible','error'); return; }
    showToast('Supprimé','success'); load();
  }
  btnNew.addEventListener('click',()=>openEdit(null));
  btnSave.addEventListener('click',doSave);
  load();
})();
</script>
{% endblock %}
