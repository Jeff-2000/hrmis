{% extends 'main/base.html' %}
{% block title %}Paie — Tableau de bord{% endblock %}
{% block content %}
<div class="container mx-auto">
  <div class="card bg-white shadow-xl border-l-4 border-orange-600">
    <div class="card-body">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-orange-600 flex items-center gap-2">
          <i class="fas fa-chart-line"></i> Tableau de bord Paie
        </h1>
        <div class="join">
          <a href="{% url 'payroll_calendar' %}" class="btn join-item bg-blue-100 text-blue-800 hover:bg-blue-200">
            <i class="fas fa-calendar-alt mr-2"></i> Calendrier
          </a>
          <a href="{% url 'payroll_variables' %}" class="btn join-item bg-indigo-100 text-indigo-800 hover:bg-indigo-200">
            <i class="fas fa-sliders mr-2"></i> Variables
          </a>
          <a href="{% url 'payroll_dashboard' %}" class="btn join-item bg-green-100 text-green-800 hover:bg-green-200">
            <i class="fas fa-rotate mr-2"></i> Actualiser
          </a>
        </div>
      </div>

      <!-- KPIs -->
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-4">
        <div class="stat bg-orange-50 rounded-box">
          <div class="stat-title text-orange-500"> Lots </div>
          <div class="stat-value text-orange-600" id="k_total">—</div>
        </div>
        <div class="stat bg-yellow-50 rounded-box">
          <div class="stat-title text-yellow-500">Brouillons</div>
          <div class="stat-value text-yellow-600" id="k_draft">—</div>
        </div>
        <div class="stat bg-blue-50 rounded-box">
          <div class="stat-title text-blue-500">Traités</div>
          <div class="stat-value text-blue-600" id="k_processed">—</div>
        </div>
        <div class="stat bg-green-50 rounded-box">
          <div class="stat-title text-green-500">Clôturés</div>
          <div class="stat-value text-green-600" id="k_closed">—</div>
        </div>
        <div class="stat bg-red-50 rounded-box">
          <div class="stat-title text-red-500">Suspendus (aujourd'hui)</div>
          <div class="stat-value text-red-600" id="k_excl">—</div>
        </div>
      </div>

      <!-- Recent runs -->
      <div class="mt-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Lots récents</h2>
        <div class="overflow-x-auto bg-gray-50 rounded-box">
          <table class="table w-full">
            <thead>
              <tr>
                <th class="whitespace-nowrap text-blue-600">Période</th>
                <th class="whitespace-nowrap text-blue-600">Politique</th>
                <th class="whitespace-nowrap text-blue-600">Statut</th>
                <th class="whitespace-nowrap text-blue-600">Généré</th>
                <th class="whitespace-nowrap text-blue-600 text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="recentTbody"><tr><td colspan="5" class="text-center">Chargement…</td></tr></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(async function(){
  try{
    const r = await fetch('/api/v1/payroll/dashboard/data/', {headers:{'X-Requested-With':'XMLHttpRequest'}});
    if(!r.ok) throw new Error('Impossible de charger le tableau de bord');
    const data = await r.json();
    const k = data.kpis || {};
    document.getElementById('k_total').textContent = k.total_runs ?? '0';
    document.getElementById('k_draft').textContent = k.draft ?? '0';
    document.getElementById('k_processed').textContent = k.processed ?? '0';
    document.getElementById('k_closed').textContent = k.closed ?? '0';
    document.getElementById('k_excl').textContent = k.excluded_today ?? '0';

    const rows = data.recent_runs || [];
    const tbody = document.getElementById('recentTbody');
    if(!rows.length){ tbody.innerHTML = `<tr><td colspan="5" class="text-center text-base-content/60">Aucun lot</td></tr>`; return; }
    tbody.innerHTML = rows.map(x=>{
      const badge = x.status==='draft' ? 'badge-warning' : (x.status==='processed'?'badge-info':'badge-success');
      return `<tr>
        <td>${String(x.month).padStart(2,'0')}/${x.year}</td>
        <td>${x.company_policy?.name || '—'}</td>
        <td><span class="badge ${badge}">${x.status.toUpperCase()}</span></td>
        <td>${x.generated_at?x.generated_at.replace('T',' ').slice(0,16):'—'}</td>
        <td class="text-right">
          <a href="/api/v1/payroll/runs/${x.id}/" class="btn btn-xs bg-blue-100 text-blue-800 hover:bg-blue-200">Voir</a>
          <a href="/api/v1/payroll/runs/${x.id}/export_csv/" target="_blank" class="btn btn-xs bg-indigo-100 text-indigo-800 hover:bg-indigo-200">
            <i class="fas fa-file-csv"></i>
          </a>
        </td>
      </tr>`;
    }).join('');
  }catch(e){ console.error(e); }
})();
</script>
{% endblock %}
