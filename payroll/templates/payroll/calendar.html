{% extends 'main/base.html' %}
{% block title %}Paie — Calendrier{% endblock %}
{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet" />
{% endblock %}
{% block content %}
<div class="container mx-auto">
  <div class="card bg-white shadow-xl border-l-4 border-orange-600">
    <div class="card-body">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-orange-600 flex items-center gap-2">
          <i class="fas fa-calendar-alt"></i> Calendrier de paie
        </h1>
        <a href="{% url 'payroll_dashboard' %}" class="btn bg-blue-100 text-blue-800 hover:bg-blue-200"><i class="fas fa-arrow-left mr-2"></i> Tableau de bord</a>
      </div>

        <div class="mt-4 min-h-[28rem] bg-gray-50 rounded-box p-2"
            id="calendar"
            data-detail-url-template="{% url 'payroll_run_detail' 0 %}">
        </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/locales-all.global.min.js"></script>
<script>
(async function(){
  const calEl = document.getElementById('calendar');
  const tpl = calEl.dataset.detailUrlTemplate || '/payroll/runs/0/';

  const runs = await fetch('/api/v1/runs/?page_size=500', {headers:{'X-Requested-With':'XMLHttpRequest'}}).then(r=>r.json());
  const list = runs.results || runs || [];

  function uiRunUrl(id){
    // replace trailing /0 or /0/ with /<id>/
    return tpl.replace(/\/0\/?$/, `/${id}/`);
  }

  const events = list.map(x=>{
    const title = `${x.company_policy?.name||''} — ${x.status.toUpperCase()}`;
    const date = (x.processed_at || x.closed_at || x.generated_at || '').slice(0,10) || `${x.year}-${String(x.month).padStart(2,'0')}-01`;
    const color = x.status==='draft' ? '#fbbf24' : (x.status==='processed' ? '#60a5fa' : '#34d399');
    return {
      id: x.id,
      title,
      start: date,
      allDay: true,
      color,
      url: uiRunUrl(x.id) // <-- use UI link
    };
  });

  const cal = new FullCalendar.Calendar(calEl, {
    locale:'fr',
    initialView:'dayGridMonth',
    headerToolbar:{left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay'},
    events,
    eventClick: (info)=>{
      // FullCalendar will navigate automatically if event.url is set,
      // but we prevent default to be explicit and handle safely.
      info.jsEvent.preventDefault();
      if (info.event.url) window.location.href = info.event.url;
    }
  });
  cal.render();
})();

</script>
{% endblock %}
