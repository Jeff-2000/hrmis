{% extends 'main/base.html' %}
{% block title %}Bulletin de Paie{% endblock %}

{% block content %}
<div class="container mx-auto">
  <div class="card bg-white shadow-xl border-l-4 border-orange-600">
    <div class="card-body">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-orange-600 flex items-center gap-2">
          <i class="fas fa-file-invoice"></i> Bulletin de Paie
        </h1>
        <div class="flex gap-2">
            <!-- PDF Button -->
            <a href="/api/v1/payslips/{{ payslip.id }}/pdf/" id="btnPdf" class="btn btn-outline btn-primary rounded-xl shadow-sm hover:shadow-md transition duration-200">
                <i class="fas fa-file-pdf mr-2 text-red-500"></i> PDF
            </a>

            <!-- Print Button -->
            <button id="btnPrint" class="btn btn-primary rounded-xl shadow-sm hover:shadow-md transition duration-200">
                <i class="fas fa-print mr-2"></i> Imprimer
            </button>
        </div>
      </div>

      <div id="meta" class="mt-2 text-sm text-base-content/70"></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
        <!-- Brut -->
        <div class="stat bg-gradient-to-r from-blue-50 to-blue-100 shadow-md rounded-2xl p-4 border border-blue-200">
            <div class="stat-title text-blue-700">Brut</div>
            <div id="gross" class="stat-value text-blue-900">—</div>
            <div class="stat-desc text-blue-600 flex items-center gap-1">
            <i class="fas fa-coins"></i> Salaire brut
            </div>
        </div>

        <!-- Impôt -->
        <div class="stat bg-gradient-to-r from-red-50 to-red-100 shadow-md rounded-2xl p-4 border border-red-200">
            <div class="stat-title text-red-700">Impôt</div>
            <div id="tax" class="stat-value text-red-900">—</div>
            <div class="stat-desc text-red-600 flex items-center gap-1">
            <i class="fas fa-file-invoice-dollar"></i> Retenue fiscale
            </div>
        </div>

        <!-- Net -->
        <div class="stat bg-gradient-to-r from-green-50 to-green-100 shadow-md rounded-2xl p-4 border border-green-200">
            <div class="stat-title text-green-700">Net</div>
            <div id="net" class="stat-value text-green-900">—</div>
            <div class="stat-desc text-green-600 flex items-center gap-1">
            <i class="fas fa-wallet"></i> Salaire net
            </div>
        </div>
        </div>
      <div class="overflow-x-auto mt-4">
        <table class="table w-full">
          <thead>
            <tr>
              <th class="whitespace-nowrap text-blue-600">Composant</th>
              <th class="whitespace-nowrap text-blue-600">Qté</th>
              <th class="whitespace-nowrap text-blue-600">Taux</th>
              <th class="whitespace-nowrap text-blue-600">Montant</th>
              <th class="whitespace-nowrap text-blue-600">Info</th>
            </tr>
          </thead>
          <tbody id="itemsTbody">
            <tr><td colspan="5" class="text-center text-base-gray">Chargement…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const id = {{ payslip_id }};
  const fmtMoney=v=>v==null?'—':new Intl.NumberFormat('fr-FR',{style:'currency',currency:'XOF'}).format(v);

  async function load(){
    try{
      const r = await fetch(`/api/v1/payslips/${id}/`, { headers:{'X-Requested-With':'XMLHttpRequest'} });
      if (!r.ok) throw new Error('Bulletin introuvable');
      const p = await r.json();
      const full = `${p.employee?.first_name||''} ${p.employee?.last_name||''}`.trim();
      document.getElementById('meta').textContent = `${full||'—'} • ${String(p.run?.month||'').padStart(2,'0')}/${p.run?.year||''} • ${p.currency?.code||'XOF'}`;
      document.getElementById('gross').textContent = fmtMoney(p.gross_pay);
      document.getElementById('tax').textContent   = fmtMoney(p.income_tax);
      document.getElementById('net').textContent   = fmtMoney(p.net_pay);

      const tbody = document.getElementById('itemsTbody');
      const items = p.items || [];
      if (!items.length){ tbody.innerHTML = `<tr><td colspan="5" class="text-center text-base-content/60">Aucun détail</td></tr>`; return; }
      tbody.innerHTML = items.map(it=>{
        const comp = it.component || {};
        const meta = it.meta && Object.keys(it.meta).length ? `<span class="badge badge-ghost">${JSON.stringify(it.meta)}</span>` : '';
        return `<tr>
          <td><span class="font-semibold">${comp.code||''}</span> — ${comp.name||''}</td>
          <td>${it.quantity ?? 1}</td>
          <td>${it.rate ?? 0}</td>
          <td class="font-semibold">${fmtMoney(it.amount)}</td>
          <td>${meta}</td>
        </tr>`;
      }).join('');

      document.getElementById('btnPdf').setAttribute('href', `/api/v1/payslips/${id}/pdf/`);
      document.getElementById('btnPdf').setAttribute('target', `_blank`);
    }catch(e){ showToast(e.message, 'error'); }
  }

  document.getElementById('btnPrint').addEventListener('click', ()=>{
    const w=window.open('', '_blank');
    w.document.write('<html><head><title>Bulletin</title></head><body>');
    w.document.write(document.querySelector('.card').outerHTML);
    w.document.write('</body></html>');
    w.document.close(); w.focus(); w.print(); w.close();
  });

  load();
})();
</script>
{% endblock %}
