{% extends 'main/base.html' %}
{% block title %}Documents{% endblock %}

{% block content %}
<div class="container mx-auto">
  <div class="card bg-white shadow-xl border-l-4 border-orange-600">
    <div class="card-body">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-orange-600 flex items-center gap-2">
          <i class="fas fa-folder-open"></i> Documents
        </h1>
        <button id="btnNew" class="btn bg-orange-600 hover:bg-orange-700 text-white">
          <i class="fas fa-upload mr-2"></i> Nouveau document
        </button>
      </div>

      <!-- Filters -->
      <div class="grid grid-cols-1 lg:grid-cols-6 gap-3 mt-4">
        <div>
          <label class="label"><span class="label-text">Type</span></label>
          <select id="fType" class="select select-bordered w-full bg-blue-50">
            <option value="">Tous</option>
            <option value="arrete">Arrêté</option>
            <option value="certificat_medical">Certificat Médical</option>
            <option value="contrat">Contrat</option>
            <option value="autre">Autre</option>
          </select>
        </div>
        <div>
          <label class="label"><span class="label-text">Statut</span></label>
          <select id="fStatus" class="select select-bordered w-full bg-blue-50">
            <option value="">Tous</option>
            <option value="to_validate">À valider</option>
            <option value="valide">Valide</option>
            <option value="expiré">Expiré</option>
          </select>
        </div>
        <div>
          <label class="label"><span class="label-text">Année min</span></label>
          <input id="fYearFrom" type="number" class="input input-bordered w-full bg-blue-50" placeholder="YYYY">
        </div>
        <div>
          <label class="label"><span class="label-text">Année max</span></label>
          <input id="fYearTo" type="number" class="input input-bordered w-full bg-blue-50" placeholder="YYYY">
        </div>

        {% if is_elevated %}
        <div>
          <label class="label"><span class="label-text">Type de contenu</span></label>
          <select id="fCT" class="select select-bordered w-full bg-blue-50">
            <option value="">Tous</option>
          </select>
        </div>
        <div>
          <label class="label"><span class="label-text">Objet (ID)</span></label>
          <input id="fObj" type="number" class="input input-bordered w-full bg-blue-50" placeholder="ID de l'objet">
        </div>
        {% else %}
        <div class="lg:col-span-2 hidden lg:block"></div>
        {% endif %}

        <div class="lg:col-span-6">
          <label class="label"><span class="label-text">Recherche (texte / émis par)</span></label>
          <input id="fQ" type="text" class="input input-bordered w-full bg-blue-50" placeholder="Mot-clé">
        </div>
      </div>

      <!-- List -->
      <div class="overflow-x-auto mt-4 bg-gray-50">
        <table class="table w-full">
          <thead>
            <tr>
              <th class="text-blue-600">Type</th>
              <th class="text-blue-600">Objet</th>
              <th class="text-blue-600">Date d'émission</th>
              <th class="text-blue-600">Émis par</th>
              <th class="text-blue-600">Statut</th>
              <th class="text-blue-600">Fichier</th>
              <th class="text-blue-600 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="tBody">
            <tr><td colspan="7" class="text-center text-base-gray">Chargement…</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="mt-3 flex items-center gap-2">
        <button id="prevPage" class="btn btn-sm bg-blue-100 text-blue-800 hover:bg-blue-200">Préc</button>
        <span id="pageInfo" class="text-sm"></span>
        <button id="nextPage" class="btn btn-sm bg-blue-100 text-blue-800 hover:bg-blue-200">Suiv</button>
      </div>
    </div>
  </div>
</div>

<!-- Upload / Edit Modal -->
<input type="checkbox" id="docModal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box bg-white border-l-4 border-orange-600 max-w-3xl">
    <h3 class="font-bold text-lg mb-2" id="mTitle">Nouveau document</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {% if is_elevated %}
      <div>
        <label class="label"><span class="label-text">Type de contenu</span></label>
        <select id="mCT" class="select select-bordered w-full bg-blue-50"></select>
      </div>
      <div>
        <label class="label"><span class="label-text">Objet (ID)</span></label>
        <input id="mObj" type="number" class="input input-bordered w-full bg-blue-50" placeholder="ex: ID Employé">
      </div>
      <div class="md:col-span-2">
        <label class="label"><span class="label-text">Rechercher Employé (optionnel)</span></label>
        <div class="flex gap-2">
          <input id="empSearch" type="text" class="input input-bordered w-full bg-blue-50" placeholder="Nom, matricule, email…">
          <button id="btnEmpSearch" class="btn bg-green-500 hover:bg-green-800">Chercher</button>
        </div>
        <div id="empResults" class="mt-2 max-h-40 overflow-auto border rounded hidden"></div>
      </div>
      {% else %}
      <div class="md:col-span-2">
        <div class="alert bg-blue-50 text-blue-800">
          <i class="fas fa-user mr-2"></i> Ce document sera rattaché à votre profil.
        </div>
      </div>
      {% endif %}

      <div>
        <label class="label"><span class="label-text">Type de document</span></label>
        <select id="mType" class="select select-bordered w-full bg-blue-50">
          <option value="arrete">Arrêté</option>
          <option value="certificat_medical">Certificat Médical</option>
          <option value="contrat">Contrat</option>
          <option value="autre">Autre</option>
        </select>
      </div>
      <div>
        <label class="label"><span class="label-text">Statut</span></label>
        <select id="mStatus" class="select select-bordered w-full bg-blue-50">
          <option value="valide">Valide</option>
          <option value="to_validate">À valider</option>
          <option value="expiré">Expiré</option>
        </select>
      </div>

      <div>
        <label class="label"><span class="label-text">Date d'émission</span></label>
        <input id="mDate" type="date" class="input input-bordered w-full bg-blue-50" placeholder="JJ/MM/AAAA">
      </div>
      <div>
        <label class="label"><span class="label-text">Émis par</span></label>
        <input id="mIssuedBy" type="text" class="input input-bordered w-full bg-blue-50" placeholder="Ex: Ministère, Médecin…">
      </div>

      <div class="md:col-span-2">
        <label class="label"><span class="label-text">Fichier (PDF, image, etc.)</span></label>
        <input id="mFile" type="file" class="file-input file-input-bordered w-full bg-blue-50"/>
      </div>
      <div class="md:col-span-2">
        <label class="label"><span class="label-text">Contenu texte (optionnel)</span></label>
        <textarea id="mText" class="textarea textarea-bordered w-full bg-blue-50" rows="4" placeholder="Texte libre si pas de fichier…"></textarea>
      </div>
    </div>

    <div class="modal-action">
      <label for="docModal" class="btn btn-ghost">Annuler</label>
      <button id="mSave" class="btn bg-orange-600 text-white">Enregistrer</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  // ---- Context ----
  const IS_ELEVATED = {{ is_elevated|yesno:"true,false" }};

  // ---- CSRF ----
  function getCookie(name){
    const v = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrf = getCookie('csrftoken');
  async function csrfFetch(url, opts={}){
    opts.headers = Object.assign({'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrf}, opts.headers||{});
    return fetch(url, opts);
  }

  // ---- State ----
  const state = { page:1, pageSize:10, total:0, editId:null, contentTypes:[] };

  // ---- Elements ----
  const tBody = document.getElementById('tBody');
  const pageInfo = document.getElementById('pageInfo');

  // Filters
  const fType = document.getElementById('fType');
  const fStatus = document.getElementById('fStatus');
  const fYearFrom = document.getElementById('fYearFrom');
  const fYearTo = document.getElementById('fYearTo');
  const fQ = document.getElementById('fQ');
  const fCT = document.getElementById('fCT');
  const fObj = document.getElementById('fObj');

  // Modal
  const modalToggle = document.getElementById('docModal');
  const mTitle = document.getElementById('mTitle');
  const mCT = document.getElementById('mCT');
  const mObj = document.getElementById('mObj');
  const mType = document.getElementById('mType');
  const mStatus = document.getElementById('mStatus');
  const mDate = document.getElementById('mDate');
  const mIssuedBy = document.getElementById('mIssuedBy');
  const mFile = document.getElementById('mFile');
  const mText = document.getElementById('mText');
  const mSave = document.getElementById('mSave');

  // Employee search (HR/ADMIN)
  const empSearch = document.getElementById('empSearch');
  const btnEmpSearch = document.getElementById('btnEmpSearch');
  const empResults = document.getElementById('empResults');

  // ---- Helpers ----
  function badgeFor(status){
    if(status==='to_validate') return '<span class="badge bg-yellow-100 text-yellow-800">À valider</span>';
    if(status==='expiré') return '<span class="badge bg-red-100 text-red-800">Expiré</span>';
    return '<span class="badge bg-green-100 text-green-800">Valide</span>';
  }
  function nameCT(ct){
    if(!ct) return '—';
    return `${ct.app_label}.${ct.model}`;
  }
  function fileLink(row){
    if(row.file) return `<a class="link text-blue-600" href="${row.file}" target="_blank">Ouvrir</a>`;
    return '—';
  }
  function paramsFromFilters(){
    const p = new URLSearchParams();
    p.set('page', state.page); p.set('page_size', state.pageSize);
    if (fType.value)    p.set('document_type', fType.value);
    if (fStatus.value)  p.set('status', fStatus.value);
    if (fYearFrom.value) p.set('year_from', fYearFrom.value);
    if (fYearTo.value)   p.set('year_to', fYearTo.value);
    if (fQ.value)        p.set('q', fQ.value);
    if (IS_ELEVATED){
      if (fCT.value)   p.set('content_type', fCT.value);
      if (fObj.value)  p.set('object_id', fObj.value);
    }
    return p;
  }

  // ---- Load content types (only for HR/ADMIN) ----
  async function loadCTs(){
    if(!IS_ELEVATED) return;

    // After (corrected)
    const r = await fetch('/api/v1/documents/contenttypes/', {
      headers: {'X-Requested-With':'XMLHttpRequest'},
      credentials: 'same-origin'
    });

    const data = await r.json(); state.contentTypes = data;
    // common ones at top
    const sorted = [...data].sort((a,b)=>{
      const A = `${a.app_label}.${a.model}`, B = `${b.app_label}.${b.model}`;
      if (A==='employee.employee') return -1;
      if (B==='employee.employee') return 1;
      return A.localeCompare(B);
    });
    fCT.innerHTML = `<option value="">Tous</option>` + sorted.map(ct=> `<option value="${ct.id}">${ct.app_label}.${ct.model}</option>`).join('');
    mCT.innerHTML = sorted.map(ct=> `<option value="${ct.id}">${ct.app_label}.${ct.model}</option>`).join('');
    // default to employee.employee
    const def = sorted.find(ct=>ct.app_label==='employee' && ct.model==='employee');
    if(def){ fCT.value = ""; mCT.value = def.id; }
  }

  // ---- Load list ----
  async function loadDocs(){
    const p = paramsFromFilters();
    tBody.innerHTML = `<tr><td colspan="7" class="text-center text-base-gray">Chargement…</td></tr>`;
    const r = await fetch(`/api/v1/documents/documents/?${p.toString()}`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
    if(!r.ok){ tBody.innerHTML = `<tr><td colspan="7" class="text-center text-red-600">Erreur</td></tr>`; return; }
    const data = await r.json();
    const rows = data.results || data || [];
    state.total = data.count || rows.length;

    if(!rows.length){
      tBody.innerHTML = `<tr><td colspan="7" class="text-center text-base-gray">Aucun document</td></tr>`;
    }else{
      tBody.innerHTML = rows.map(x=>{
        const ct = state.contentTypes.find(c=>c.id===x.content_type) || null;
        return `<tr>
          <td class="capitalize">${(x.document_type||'').replace('_',' ')}</td>
          <td>${nameCT(ct)} #${x.object_id||'—'}</td>
          <td>${x.issuance_date||'—'}</td>
          <td>${x.issued_by||'—'}</td>
          <td>${badgeFor(x.status)}</td>
          <td>${fileLink(x)}</td>
          <td class="text-right flex justify-end gap-2">
            ${x.file ? `<a class="btn btn-xs bg-blue-100 text-blue-800" href="${x.file}" target="_blank"><i class="fas fa-eye"></i></a>`:''}
            ${IS_ELEVATED ? `<button class="btn btn-xs bg-yellow-100 text-yellow-800" data-edit="${x.id}"><i class="fas fa-pen"></i></button>`:''}
            ${IS_ELEVATED ? `<button class="btn btn-xs bg-red-100 text-red-800" data-del="${x.id}"><i class="fas fa-trash"></i></button>`:''}
          </td>
        </tr>`;
      }).join('');

      // actions
      tBody.querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click', ()=> openEdit(b.dataset.edit)));
      tBody.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', ()=> delDoc(b.dataset.del)));
    }
    pageInfo.textContent = state.total ? `Page ${state.page} — ${state.total} éléments` : `Page ${state.page}`;
  }

  // ---- New / Edit ----
  function clearModal(){
    state.editId = null;
    mTitle.textContent = 'Nouveau document';
    if (IS_ELEVATED) {
      mObj.value = '';
      // keep mCT selection
    }
    mType.value = 'arrete';
    mStatus.value = 'valide';
    mDate.value = '';
    mIssuedBy.value = '';
    mFile.value = '';
    mText.value = '';
  }

  async function openEdit(id){
    const r = await fetch(`/api/v1/documents/documents/${id}/`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
    if(!r.ok) return showToast('Introuvable','error');
    const x = await r.json();
    state.editId = id;
    mTitle.textContent = 'Modifier document';
    if (IS_ELEVATED){ mCT.value = x.content_type; mObj.value = x.object_id || ''; }
    mType.value = x.document_type || 'arrete';
    mStatus.value = x.status || 'valide';
    mDate.value = (x.issuance_date||'');
    mIssuedBy.value = x.issued_by || '';
    mText.value = x.content_text || '';
    mFile.value = ''; // cannot prefill file
    modalToggle.checked = true;
  }

  async function saveModal(){
    const fd = new FormData();
    fd.append('document_type', mType.value);
    fd.append('status', mStatus.value);
    if (mDate.value) fd.append('issuance_date', mDate.value);
    if (mIssuedBy.value) fd.append('issued_by', mIssuedBy.value);
    if (mText.value) fd.append('content_text', mText.value);
    if (mFile.files[0]) fd.append('file', mFile.files[0]);

    if (IS_ELEVATED){
      if (mCT.value) fd.append('content_type', mCT.value);
      if (mObj.value) fd.append('object_id', mObj.value);
    }

    let url = '/api/v1/documents/documents/';
    let method = 'POST';
    if (state.editId){
      url = `/api/v1/documents/documents/${state.editId}/`;
      method = 'PATCH';
    }
    const r = await csrfFetch(url, { method, body: fd });
    if(!r.ok){
      const e = await r.json().catch(()=>({detail:'Erreur'}));
      return showToast(e.detail || Object.values(e)[0] || 'Erreur', 'error');
    }
    modalToggle.checked = false;
    showToast('Enregistré', 'success');
    clearModal(); loadDocs();
  }

  async function delDoc(id){
    // small confirm
    if(!confirm('Supprimer ce document ?')) return;
    const r = await csrfFetch(`/api/v1/documents/documents/${id}/`, { method:'DELETE' });
    if(!r.ok){ return showToast('Suppression impossible', 'error'); }
    showToast('Supprimé', 'success'); loadDocs();
  }

  // ---- Employee search (HR/ADMIN) ----
  async function searchEmployees(){
    empResults.classList.remove('hidden');
    empResults.innerHTML = `<div class="p-2 text-sm text-gray-500">Recherche…</div>`;
    const q = empSearch.value.trim();
    if (!q){ empResults.innerHTML = `<div class="p-2 text-sm">Entrez un terme.</div>`; return; }
    const p = new URLSearchParams({ search:q, page_size:10 });
    const r = await fetch(`/api/v1/employees/?${p.toString()}`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
    const data = await r.json(); const rows = data.results || data || [];
    if (!rows.length){ empResults.innerHTML = `<div class="p-2 text-sm">Aucun résultat</div>`; return; }
    empResults.innerHTML = rows.map(e=>`
      <div class="p-2 hover:bg-blue-50 cursor-pointer" data-emp="${e.id}">
        ${e.first_name||''} ${e.last_name||''} <span class="text-xs text-gray-500">#${e.id}</span>
      </div>`).join('');
    empResults.querySelectorAll('[data-emp]').forEach(el=>{
      el.addEventListener('click', ()=>{
        const id = el.dataset.emp;
        mObj.value = id;
        const ct = state.contentTypes.find(c=>c.app_label==='employee' && c.model==='employee');
        if(ct) mCT.value = ct.id;
        empResults.classList.add('hidden');
      });
    });
  }

  // ---- Wire up ----
  document.getElementById('btnNew').addEventListener('click', ()=>{
    clearModal(); modalToggle.checked = true;
  });
  mSave.addEventListener('click', saveModal);

  {% if is_elevated %}
  btnEmpSearch.addEventListener('click', searchEmployees);
  {% endif %}

  // filters
  [fType, fStatus, fCT, fObj, fYearFrom, fYearTo].forEach(el=>{
    if (!el) return;
    el.addEventListener('change', ()=>{ state.page=1; loadDocs(); });
  });
  fQ.addEventListener('keyup', (e)=>{ if(e.key==='Enter'){ state.page=1; loadDocs(); } });

  // pager
  document.getElementById('prevPage').addEventListener('click', ()=>{ if(state.page>1){ state.page--; loadDocs(); }});
  document.getElementById('nextPage').addEventListener('click', ()=>{ state.page++; loadDocs(); });

  // init
  loadCTs().then(loadDocs);
})();
</script>
{% endblock %}
